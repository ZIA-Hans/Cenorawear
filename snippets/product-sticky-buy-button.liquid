{%- comment -%}
  移动端吸底加购按钮
  
  核心设计原则：从产品 JSON 数据源读取 variant 信息，而不是从 DOM 抓取
  参考主加购按钮的简洁逻辑，避免复杂的 DOM 同步
  
  参数:
  - product: 产品对象
  - current_variant: 当前选中的变体
  - section: section 对象
  - buy_button_block: buy_button block 对象
  - form_id: 表单ID
{%- endcomment -%}

{%- liquid
  assign sticky_form_id = form_id | append: '-sticky'
  assign sticky_form_class = 'margin-0 f8pr f8pr-buy-button'
  if current_variant == null or current_variant.available == false
    assign sticky_form_class = sticky_form_class | append: ' unavailable'
  endif
-%}

{%- comment -%} 吸底按钮容器 - 紧凑型布局：左边variant信息，右边价格+按钮 {%- endcomment -%}
<div
  id="product-buy-button-sticky-{{ section.id }}"
  class="product-buy-button-sticky mobile-only"
  data-product-id="{{ product.id }}"
  style="display: none;"
>
  {%- form 'product', product, id: sticky_form_id, class: sticky_form_class, autocomplete: 'off' -%}
    {%- comment -%} 必须明确指定 variant ID {%- endcomment -%}
    <input type="hidden" name="id" value="{{ current_variant.id }}">
    <input type="hidden" name="quantity" value="1">
    
    <div class="sticky-buy-content">
      {%- comment -%} 左侧：购买信息 {%- endcomment -%}
      <div class="sticky-buy-info">
        <div class="sticky-product-title">{{ product.title }}</div>
        {%- if current_variant and current_variant.title != 'Default Title' -%}
          <div class="sticky-variant-options">{{ current_variant.title | replace: ' / ', ' / ' }}</div>
        {%- endif -%}
      </div>

      {%- comment -%} 右侧：价格和加购按钮 {%- endcomment -%}
      <div class="sticky-buy-action">
        <div class="sticky-price">
          {%- if current_variant.compare_at_price > current_variant.price -%}
            <span class="sticky-price-sale">{{ current_variant.price | money }}</span>
            <span class="sticky-price-compare">{{ current_variant.compare_at_price | money }}</span>
          {%- else -%}
            <span class="sticky-price-regular">{{ current_variant.price | money }}</span>
          {%- endif -%}
        </div>

        {%- comment -%} 参考主按钮逻辑 {%- endcomment -%}
        {%- if current_variant.available -%}
          <button type="submit" class="sticky-add-button overlay-buy_button {{ buy_button_block.settings.button_style }}">
            <span class="sticky-button-text">{{ 'product.form.add_to_cart' | t }}</span>
            <span class="sticky-button-loading" style="display: none;">
              <svg class="sticky-spinner" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="60" stroke-dashoffset="15" stroke-linecap="round"></circle>
              </svg>
            </span>
          </button>
        {%- else -%}
          <button type="submit" class="sticky-add-button disabled overlay-unavailable_buy_button {{ buy_button_block.settings.button_style }}" disabled>
            {{ 'product.form.not_in_stock' | t }}
          </button>
        {%- endif -%}
      </div>
    </div>
  {%- endform -%}
</div>

<style>
  @media only screen and (max-width: 760px) {
      .product-buy-button-sticky {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          width: 100%;
          z-index: 99;
          background: linear-gradient(133deg, #fdf2e9 9%, #fdf6ed 47%, #fdf2e9 86%);
          padding: 16px;
          box-shadow: rgba(0, 0, 0, 0.1) 0px 6px 30px -4px;
          border-top: 1px solid var(--input_bd, #e0e0e0);
          border-radius: 8px 8px 0 0;
          transform: translateY(100%);
          transition: transform 0.3s ease-in-out;
      }

      .product-buy-button-sticky.show {
          transform: translateY(0);
      }

      .sticky-buy-content {
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 12px;
          height: 44px;
      }

      .sticky-buy-info {
          flex: 1;
          min-width: 0;
          display: flex;
          flex-direction: column;
          justify-content: center;
          gap: 2px;
      }

      .sticky-product-title {
          font-size: 13px;
          font-weight: 600;
          line-height: 1.2;
          color: var(--text_color, #000);
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }

      .sticky-variant-options {
          font-size: 11px;
          line-height: 1.2;
          color: var(--text_color_light, #666);
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }

      .sticky-buy-action {
          display: flex;
          align-items: center;
          gap: 12px;
          flex-shrink: 0;
      }

      .sticky-price {
          display: flex;
          flex-direction: column;
          align-items: flex-end;
          gap: 2px;
      }

      .sticky-price-regular {
          font-size: 15px;
          font-weight: 700;
          line-height: 1;
          color: var(--text_color, #000);
      }

      .sticky-price-sale {
          font-size: 15px;
          font-weight: 700;
          line-height: 1;
          color: var(--sale_color, #d32f2f);
      }

      .sticky-price-compare {
          font-size: 12px;
          line-height: 1;
          color: var(--text_color_light, #999);
          text-decoration: line-through;
      }

      .sticky-add-button {
          height: 44px;
          padding: 0 20px;
          font-size: 14px;
          font-weight: 600;
          white-space: nowrap;
          border: none;
          cursor: pointer;
          border-radius: 4px;
          transition: all 0.2s ease;
          background: #000;
      }

      .sticky-add-button:disabled {
          cursor: not-allowed;
          opacity: 0.6;
      }

      .sticky-add-button.loading {
          cursor: wait;
          pointer-events: none;
      }

      .sticky-button-text,
      .sticky-button-loading {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
      }

      .sticky-add-button.loading .sticky-button-text {
          display: none;
      }

      .sticky-add-button.loading .sticky-button-loading {
          display: flex !important;
      }

      .sticky-spinner {
          width: 16px;
          height: 16px;
          animation: sticky-spin 1s linear infinite;
      }

      @keyframes sticky-spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      html.product-buy-button-sticky-active {
          padding-bottom: calc(44px + 16px + 16px + 1px);
      }
  }
</style>

<script>
  (function () {
    'use strict';

    // ========== 1. 获取产品数据 ==========
    var productData = null;
    
    function loadProductData() {
      if (productData) return productData;
      
      var productJsonScript = document.querySelector('script[type="application/json"][data-product-id="{{ product.id }}"]');
      if (productJsonScript) {
        try {
          productData = JSON.parse(productJsonScript.textContent);
          console.log('[Sticky Button] Product data loaded');
        } catch (e) {
          console.error('[Sticky Button] Failed to parse product JSON:', e);
        }
      }
      
      if (!productData) {
        console.warn('[Sticky Button] Product data not found, will retry on event');
      }
      
      return productData;
    }
    
    // 尝试立即加载（可能成功，取决于 DOM 解析顺序）
    loadProductData();

    // ========== 2. 格式化价格函数（参考 Shopify money filter）==========
    function formatMoney(cents, format) {
      if (typeof cents === 'string') {
        cents = cents.replace('.', '');
      }
      
      // 确保 cents 是数字
      cents = parseInt(cents, 10) || 0;
      
      var placeholderRegex = /\{\{\s*(\w+)\s*\}\}/;
      var formatString = format || '${{amount}}';
      
      // 检查格式字符串是否有效
      var match = formatString.match(placeholderRegex);
      if (!match) {
        // 如果格式无效，直接返回简单格式的价格
        return '$' + (cents / 100).toFixed(2);
      }

      function formatWithDelimiters(number, precision, thousands, decimal) {
        precision = precision || 2;
        thousands = thousands || ',';
        decimal = decimal || '.';

        if (isNaN(number) || number == null) {
          return '0';
        }

        number = (number / 100.0).toFixed(precision);

        var parts = number.split('.');
        var dollars = parts[0].replace(/(\d)(?=(\d\d\d)+(?!\d))/g, '$1' + thousands);
        var centsStr = parts[1] ? (decimal + parts[1]) : '';

        return dollars + centsStr;
      }

      var value = '';
      switch (match[1]) {
        case 'amount':
          value = formatWithDelimiters(cents, 2);
          break;
        case 'amount_no_decimals':
          value = formatWithDelimiters(cents, 0);
          break;
        case 'amount_with_comma_separator':
          value = formatWithDelimiters(cents, 2, '.', ',');
          break;
        case 'amount_no_decimals_with_comma_separator':
          value = formatWithDelimiters(cents, 0, '.', ',');
          break;
        case 'amount_no_decimals_with_space_separator':
          value = formatWithDelimiters(cents, 0, ' ');
          break;
        case 'amount_with_apostrophe_separator':
          value = formatWithDelimiters(cents, 2, "'");
          break;
        default:
          value = formatWithDelimiters(cents, 2);
      }

      return formatString.replace(placeholderRegex, value);
    }

    // Shopify money format (从 theme settings 获取，或使用默认值)
    var moneyFormat = window.theme && window.theme.moneyFormat ? window.theme.moneyFormat : '${{amount}}';

    // ========== 3. 更新吸底按钮显示函数（核心逻辑）==========
    function updateStickyButton(variantId) {
      console.log('[Sticky Button] Updating for variant:', variantId);
      
      var stickyButton = document.getElementById('product-buy-button-sticky-{{ section.id }}');
      var stickyForm = document.getElementById('{{ sticky_form_id }}');
      
      if (!stickyButton || !stickyForm) {
        console.error('[Sticky Button] Elements not found');
        return;
      }

      // 确保产品数据已加载
      if (!productData) {
        loadProductData();
      }

      // 从产品数据中找到对应的 variant
      var variant = null;
      if (productData && productData.variants) {
        variant = productData.variants.find(function(v) {
          return v.id == variantId;
        });
      }

      if (!variant) {
        console.error('[Sticky Button] Variant not found:', variantId, '- falling back to DOM sync');
        // Fallback: 从 DOM 同步基本信息
        fallbackDOMSync(stickyButton, stickyForm);
        return;
      }

      console.log('[Sticky Button] Found variant:', variant.title);

      // 1. 更新表单的 variant ID（关键！）
      var variantInput = stickyForm.querySelector('input[name="id"]');
      if (variantInput) {
        variantInput.value = variant.id;
      }

      // 2. 更新 variant options 显示
      var variantOptionsEl = stickyButton.querySelector('.sticky-variant-options');
      if (variantOptionsEl) {
        if (variant.title && variant.title !== 'Default Title') {
          variantOptionsEl.textContent = variant.title.replace(/ \/ /g, ' / ');
          variantOptionsEl.style.display = '';
        } else {
          variantOptionsEl.style.display = 'none';
        }
      }

      // 3. 更新价格显示
      var priceContainer = stickyButton.querySelector('.sticky-price');
      if (priceContainer) {
        var regularPriceEl = priceContainer.querySelector('.sticky-price-regular');
        var salePriceEl = priceContainer.querySelector('.sticky-price-sale');
        var comparePriceEl = priceContainer.querySelector('.sticky-price-compare');

        var hasComparePrice = variant.compare_at_price && variant.compare_at_price > variant.price;

        if (hasComparePrice) {
          // 显示促销价
          if (salePriceEl) {
            salePriceEl.textContent = formatMoney(variant.price, moneyFormat);
            salePriceEl.style.display = '';
          }
          if (comparePriceEl) {
            comparePriceEl.textContent = formatMoney(variant.compare_at_price, moneyFormat);
            comparePriceEl.style.display = '';
          }
          if (regularPriceEl) {
            regularPriceEl.style.display = 'none';
          }
        } else {
          // 显示常规价
          if (regularPriceEl) {
            regularPriceEl.textContent = formatMoney(variant.price, moneyFormat);
            regularPriceEl.style.display = '';
          }
          if (salePriceEl) {
            salePriceEl.style.display = 'none';
          }
          if (comparePriceEl) {
            comparePriceEl.style.display = 'none';
          }
        }
      }

      // 4. 更新按钮状态（参考主按钮逻辑）
      var addButton = stickyButton.querySelector('.sticky-add-button');
      var buttonText = addButton ? addButton.querySelector('.sticky-button-text') : null;

      if (addButton && buttonText) {
        if (variant.available) {
          addButton.disabled = false;
          addButton.classList.remove('disabled');
          addButton.className = addButton.className.replace(/overlay-unavailable_buy_button/g, 'overlay-buy_button');
          buttonText.textContent = '{{ 'product.form.add_to_cart' | t }}';
        } else {
          addButton.disabled = true;
          addButton.classList.add('disabled');
          addButton.className = addButton.className.replace(/overlay-buy_button/g, 'overlay-unavailable_buy_button');
          buttonText.textContent = '{{ 'product.form.not_in_stock' | t }}';
        }

        // 移除 loading 状态
        addButton.classList.remove('loading');
      }

      console.log('[Sticky Button] Update complete');
    }

    // ========== 3.5 Fallback: DOM 同步（当产品 JSON 不可用时）==========
    function fallbackDOMSync(stickyButton, stickyForm) {
      console.log('[Sticky Button] Using fallback DOM sync');
      
      var originalForm = document.getElementById('{{ form_id }}');
      if (!originalForm) {
        console.error('[Sticky Button] Original form not found');
        return;
      }
      
      // 1. 同步 variant ID
      var originalVariantInput = originalForm.querySelector('input[name="id"]');
      var stickyVariantInput = stickyForm.querySelector('input[name="id"]');
      if (originalVariantInput && stickyVariantInput) {
        stickyVariantInput.value = originalVariantInput.value;
      }
      
      // 2. 同步选项文本（从 .f8pr-variant-selection 获取）
      var variantSelection = document.querySelector('#shopify-section-{{ section.id }} .f8pr-variant-selection');
      var variantOptionsEl = stickyButton.querySelector('.sticky-variant-options');
      if (variantSelection && variantOptionsEl) {
        var radios = variantSelection.querySelectorAll('input[type="radio"]:checked:not([name="id"])');
        var optionValues = [];
        radios.forEach(function(radio) {
          optionValues.push(radio.title || radio.value);
        });
        if (optionValues.length > 0) {
          variantOptionsEl.textContent = optionValues.join(' / ');
          variantOptionsEl.style.display = '';
        }
      }
      
      // 3. 同步价格（从主表单抓取）
      var mainPriceContainer = originalForm.querySelector('.s1pr');
      var priceContainer = stickyButton.querySelector('.sticky-price');
      if (mainPriceContainer && priceContainer) {
        var regularPriceEl = priceContainer.querySelector('.sticky-price-regular');
        var salePriceEl = priceContainer.querySelector('.sticky-price-sale');
        var comparePriceEl = priceContainer.querySelector('.sticky-price-compare');
        
        var mainPriceSale = mainPriceContainer.querySelector('.s1bx');
        var mainPriceCompare = mainPriceContainer.querySelector('.old');
        
        if (mainPriceSale && mainPriceCompare) {
          if (salePriceEl) {
            salePriceEl.textContent = mainPriceSale.textContent.trim();
            salePriceEl.style.display = '';
          }
          if (comparePriceEl) {
            comparePriceEl.textContent = mainPriceCompare.textContent.trim();
            comparePriceEl.style.display = '';
          }
          if (regularPriceEl) regularPriceEl.style.display = 'none';
        } else {
          var priceText = mainPriceContainer.textContent.trim().split('\n')[0].trim();
          if (regularPriceEl) {
            regularPriceEl.textContent = priceText;
            regularPriceEl.style.display = '';
          }
          if (salePriceEl) salePriceEl.style.display = 'none';
          if (comparePriceEl) comparePriceEl.style.display = 'none';
        }
      }
      
      // 4. 同步按钮状态
      var mainButton = originalForm.querySelector('button[type="submit"]');
      var addButton = stickyButton.querySelector('.sticky-add-button');
      var buttonText = addButton ? addButton.querySelector('.sticky-button-text') : null;
      
      if (mainButton && addButton && buttonText) {
        if (mainButton.disabled) {
          addButton.disabled = true;
          addButton.classList.add('disabled');
          buttonText.textContent = '{{ 'product.form.not_in_stock' | t }}';
        } else {
          addButton.disabled = false;
          addButton.classList.remove('disabled');
          buttonText.textContent = '{{ 'product.form.add_to_cart' | t }}';
        }
        addButton.classList.remove('loading');
      }
      
      console.log('[Sticky Button] Fallback sync complete');
    }

    // ========== 4. 监听 variant 更新事件 ==========
    window.addEventListener('themeVariantUpdated', function() {
      console.log('[Sticky Button] themeVariantUpdated event received');
      
      // 显示 loading 状态
      var stickyButton = document.getElementById('product-buy-button-sticky-{{ section.id }}');
      var addButton = stickyButton ? stickyButton.querySelector('.sticky-add-button') : null;
      if (addButton) {
        addButton.classList.add('loading');
      }

      // 延迟获取 variant ID，确保 DOM 已更新
      setTimeout(function() {
        // 从 .f8pr-variant-selection 的 data-current-variant 属性获取当前 variant ID
        var variantSelection = document.querySelector('#shopify-section-{{ section.id }} .f8pr-variant-selection');
        var variantId = variantSelection ? variantSelection.getAttribute('data-current-variant') : null;

        if (variantId) {
          updateStickyButton(variantId);
        } else {
          console.error('[Sticky Button] Could not get current variant ID');
          // 移除 loading 状态
          if (addButton) {
            addButton.classList.remove('loading');
          }
        }
      }, 150);
    });

    // ========== 5. 初始化显隐逻辑（IntersectionObserver）==========
    function initStickyButtonVisibility() {
      var buyButton = document.getElementById('product-buy-button-{{ section.id }}');
      var stickyButton = document.getElementById('product-buy-button-sticky-{{ section.id }}');

      if (!buyButton || !stickyButton) {
        return;
      }

      // 只在移动端启用
      if (window.innerWidth > 760) {
        return;
      }

      // 将吸底按钮移到 body 最后
      var rootElement = document.getElementById('root');
      var targetParent = rootElement || document.body;
      if (stickyButton.parentNode !== targetParent) {
        targetParent.appendChild(stickyButton);
      }

      // 显示/隐藏函数
      function showStickyButton() {
        stickyButton.style.display = 'block';
        if (stickyButton.parentNode !== targetParent) {
          targetParent.appendChild(stickyButton);
        }
        setTimeout(function () {
          stickyButton.classList.add('show');
          document.documentElement.classList.add('product-buy-button-sticky-active');
        }, 10);
      }

      function hideStickyButton() {
        stickyButton.classList.remove('show');
        document.documentElement.classList.remove('product-buy-button-sticky-active');
        setTimeout(function () {
          if (!stickyButton.classList.contains('show')) {
            stickyButton.style.display = 'none';
          }
        }, 300);
      }

      // IntersectionObserver 监听主按钮
      var observer = new IntersectionObserver(
        function (entries) {
          entries.forEach(function (entry) {
            if (!entry.isIntersecting) {
              showStickyButton();
            } else {
              hideStickyButton();
            }
          });
        },
        {
          threshold: 0,
          rootMargin: '0px',
        }
      );

      observer.observe(buyButton);

      // 初始检查
      setTimeout(function () {
        var rect = buyButton.getBoundingClientRect();
        var isVisible = rect.top >= 0 && rect.bottom <= (window.innerHeight || document.documentElement.clientHeight);
        if (!isVisible) {
          showStickyButton();
        }
      }, 500);

      // 响应窗口大小变化
      var resizeTimer;
      window.addEventListener('resize', function () {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function () {
          if (window.innerWidth > 760) {
            stickyButton.style.display = 'none';
            stickyButton.classList.remove('show');
            document.documentElement.classList.remove('product-buy-button-sticky-active');
            observer.disconnect();
          } else {
            observer.observe(buyButton);
            var rect = buyButton.getBoundingClientRect();
            var isVisible = rect.top >= 0 && rect.bottom <= (window.innerHeight || document.documentElement.clientHeight);
            if (!isVisible) {
              showStickyButton();
            }
          }
        }, 250);
      });
    }

    // ========== 6. 处理加购 loading 状态 ==========
    function initFormSubmitHandler() {
      var stickyForm = document.getElementById('{{ sticky_form_id }}');
      var stickyButton = document.getElementById('product-buy-button-sticky-{{ section.id }}');
      var addButton = stickyButton ? stickyButton.querySelector('.sticky-add-button') : null;

      if (stickyForm && addButton) {
        stickyForm.addEventListener('submit', function() {
          addButton.classList.add('loading');
          addButton.disabled = true;

          // 监听加购完成事件
          var handleCartUpdate = function() {
            setTimeout(function() {
              addButton.classList.remove('loading');
              addButton.disabled = false;
            }, 500);
            document.removeEventListener('cart:updated', handleCartUpdate);
          };

          document.addEventListener('cart:updated', handleCartUpdate);

          // 备用方案：2秒后自动恢复
          setTimeout(function() {
            if (addButton.classList.contains('loading')) {
              addButton.classList.remove('loading');
              addButton.disabled = false;
            }
          }, 2000);
        });
      }
    }

    // ========== 7. 启动 ==========
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        initStickyButtonVisibility();
        initFormSubmitHandler();
      });
    } else {
      initStickyButtonVisibility();
      initFormSubmitHandler();
    }
  })();
</script>
