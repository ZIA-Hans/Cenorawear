# 规格：赠品的购物车添加

**能力:** `cart`  
**变更ID:** `add-option-gift-product-association`

## 概述

本规格定义了当选择赠品关联时，购物车添加流程如何处理多个SKU，确保主商品变体和关联赠品都被原子性地添加到购物车。

---

## 新增需求

### 需求：加入购物车时收集赠品变体ID

**ID:** `GIFT-CART-001`  
**优先级:** 必须

当用户提交加入购物车表单时，系统必须从选中的赠品关联复选框收集所有选定的赠品变体ID。

#### 场景：选择单个赠品关联

**假设** 产品表单包含：
- 主变体ID：99999（来自 `input[name="id"]`）
- 赠品复选框选中，变体ID：12345（来自 `data-gift-variant-id`）
- 数量：2

**当** 用户点击"加入购物车"

**那么** 系统收集：
```javascript
{
  mainVariantId: "99999",
  quantity: 2,
  giftVariantIds: ["12345"]
}
```

#### 场景：未选择赠品关联

**假设** 产品表单包含：
- 主变体ID：99999
- 未选中赠品复选框
- 数量：1

**当** 用户点击"加入购物车"

**那么** 系统收集：
```javascript
{
  mainVariantId: "99999",
  quantity: 1,
  giftVariantIds: []
}
```

#### 场景：选择多个赠品关联

**假设** 不同选项有多个赠品关联  
**并且** 用户已选中：
- 赠品 1（变体 12345）
- 赠品 2（变体 67890）

**当** 用户点击"加入购物车"

**那么** 系统收集两个赠品变体ID：
```javascript
{
  mainVariantId: "99999",
  quantity: 1,
  giftVariantIds: ["12345", "67890"]
}
```

---

### 需求：向购物车API提交多个商品

**ID:** `GIFT-CART-002`  
**优先级:** 必须

系统必须使用Shopify的 `/cart/add.js` 端点的 `items` 数组格式在单个请求中添加多个商品。

**请求格式：**
```javascript
POST /cart/add.js
Content-Type: application/json

{
  "items": [
    { "id": "main-variant-id", "quantity": X },
    { "id": "gift-variant-id-1", "quantity": 1 },
    { "id": "gift-variant-id-2", "quantity": 1 }
  ]
}
```

#### 场景：将主商品和赠品加入购物车

**假设** 用户已选择：
- 主变体：99999，数量：2
- 赠品变体：12345

**当** 触发加入购物车时

**那么** 系统POST到 `/cart/add.js`：
```json
{
  "items": [
    { "id": "99999", "quantity": 2 },
    { "id": "12345", "quantity": 1 }
  ]
}
```

**并且** 两个商品都加入购物车  
**并且** 购物车数量增加3（2个主商品 + 1个赠品）

#### 场景：未选择赠品时仅添加主商品

**假设** 主变体：99999，数量：1  
**并且** 未选中赠品复选框

**当** 触发加入购物车时

**那么** 系统POST到 `/cart/add.js`：
```json
{
  "items": [
    { "id": "99999", "quantity": 1 }
  ]
}
```

**并且** 仅添加主商品

---

### 需求：赠品数量固定为一

**ID:** `GIFT-CART-003`  
**优先级:** 必须

无论主商品数量如何，赠品必须始终以数量 = 1 添加。

#### 场景：主商品数量不影响赠品数量

**假设** 用户选择：
- 主商品数量：5
- 赠品复选框：选中

**当** 执行加入购物车时

**那么** items数组包含：
```json
[
  { "id": "main-id", "quantity": 5 },
  { "id": "gift-id", "quantity": 1 }
]
```

**并且** 赠品仅添加一次

---

### 需求：原子性购物车添加

**ID:** `GIFT-CART-004`  
**优先级:** 必须

购物车添加必须是原子性的 - 要么所有商品（主商品 + 赠品）都成功添加，要么都不添加。如果请求失败，购物车状态不得部分更新。

#### 场景：成功的多商品添加

**假设** 有效的主商品和赠品变体ID  
**并且** 两个商品都有可用库存

**当** 发送购物车添加请求时

**那么** Shopify返回成功（200 OK）  
**并且** 响应包含所有添加的商品  
**并且** 购物车更新包含所有商品

#### 场景：失败的购物车添加回滚

**假设** 主变体库存不足

**当** 发送购物车添加请求时

**那么** Shopify返回错误（422）  
**并且** 没有商品加入购物车  
**并且** 购物车状态保持不变  
**并且** 用户看到错误消息

---

### 需求：错误处理和用户反馈

**ID:** `GIFT-CART-005`  
**优先级:** 必须

系统必须优雅地处理购物车添加错误并向用户提供清晰的反馈：
- 成功：显示成功消息，更新购物车数量/抽屉
- 库存错误：显示"库存不足"消息
- 网络错误：显示"请重试"消息
- 一般错误：显示API响应的错误消息

#### 场景：主商品库存不足

**假设** 主商品缺货

**当** 用户尝试加入购物车时

**那么** 购物车API返回422错误  
**并且** 系统显示："抱歉，此商品当前缺货"  
**并且** 购物车保持不变  
**并且** 加入购物车按钮重新启用

#### 场景：购物车添加期间网络错误

**假设** 请求期间网络连接失败

**当** 加入购物车请求超时时

**那么** 系统显示："连接错误。请检查您的网络连接并重试。"  
**并且** 加入购物车按钮重新启用  
**并且** 没有商品加入购物车

#### 场景：赠品不可用

**假设** 赠品变体不存在或已禁用

**当** 购物车添加请求包含无效的赠品变体ID时

**那么** Shopify返回错误  
**并且** 系统显示Shopify API返回的错误消息  
**并且** 主商品和赠品都不添加

_注：初期实施依赖Shopify标准错误响应，不添加赠品特定的错误消息。_

---

### 需求：添加后更新购物车UI

**ID:** `GIFT-CART-006`  
**优先级:** 必须

成功加入购物车后，系统必须更新：
- 页眉中的购物车商品数量
- 购物车抽屉内容（如适用）
- 侧边购物车小部件（如适用）
- 显示徽章数量的任何购物车指示器

#### 场景：添加后更新购物车数量

**假设** 购物车当前有0个商品  
**并且** 用户添加主商品（数量1）+ 赠品（数量1）

**当** 购物车添加成功时

**那么** 页眉中的购物车数量更新为2  
**并且** 购物车图标徽章显示"2"

#### 场景：用两个商品更新购物车抽屉

**假设** 购物车抽屉可见  
**并且** 用户添加主商品 + 赠品

**当** 购物车添加成功时

**那么** 购物车抽屉刷新  
**并且** 购物车抽屉显示：
  - 主商品行项目
  - 赠品行项目
  - 更新的小计

---

### 需求：购物车商品独立性

**ID:** `GIFT-CART-007`  
**优先级:** 必须

加入购物车后，主商品和赠品必须是独立的行项目。用户应该能够：
- 移除赠品而不移除主商品
- 移除主商品而不移除赠品
- 调整主商品数量而不影响赠品

_注意：链接行为（例如，移除主商品时自动移除赠品）不在初始实施范围内。_

#### 场景：独立地从购物车移除赠品

**假设** 购物车包含：
- 主商品（数量2）
- 赠品（数量1）

**当** 用户点击赠品行的移除

**那么** 仅移除赠品  
**并且** 主商品保留在购物车中，数量为2  
**并且** 购物车相应更新

#### 场景：更新主商品数量

**假设** 购物车包含：
- 主商品（数量1）
- 赠品（数量1）

**当** 用户将主商品数量更新为3

**那么** 主商品更新为数量3  
**并且** 赠品保持数量1（不变）

---

### 需求：购物车页面显示

**ID:** `GIFT-CART-008`  
**优先级:** 应该

赠品在购物车中作为普通SKU显示，使用Shopify标准的行项目渲染逻辑：
- 标准产品图片和标题
- 价格显示（$0.00或实际价格）
- 标准数量和移除控件

_初期实施不添加特殊视觉区分，依赖Shopify标准购物车模板。未来可通过主题自定义添加"免费"标记。_

#### 场景：赠品作为标准行项目显示

**假设** 赠品价格为$0.00  
**并且** 赠品在购物车中

**当** 用户查看购物车页面或抽屉时

**那么** 赠品行项目显示：
- 产品图片
- 产品标题
- 价格：$0.00
- 标准的数量和移除按钮

**并且** 使用与其他商品相同的渲染逻辑

---

### 需求：分析和追踪

**ID:** `GIFT-CART-009`  
**优先级:** 应该

购物车添加事件应该包含赠品的追踪以启用分析：
- 追踪何时选择赠品
- 追踪包含赠品的购物车添加
- 在结账分析中追踪赠品

#### 场景：触发带赠品信息的分析事件

**假设** 已配置分析追踪  
**并且** 用户添加主商品 + 赠品

**当** 购物车添加成功时

**那么** 系统触发分析事件：
```javascript
{
  event: 'add_to_cart',
  items: [
    { id: 'main-variant', quantity: 1, price: 137.00 },
    { id: 'gift-variant', quantity: 1, price: 0, is_gift: true }
  ]
}
```

---

### 需求：防止重复赠品

**ID:** `GIFT-CART-010`  
**优先级:** 应该

系统应该检查购物车中是否已存在赠品，并根据业务逻辑防止重复添加。

_这是可选行为，可能稍后配置。默认行为是允许重复（标准Shopify购物车行为）。_

#### 场景：允许重复赠品添加（默认）

**假设** 购物车已包含赠品（数量1）  
**并且** 用户再次添加相同主商品 + 相同赠品

**当** 执行购物车添加时

**那么** 赠品数量增加到2  
**并且** 两次添加都成功

#### 场景：防止重复赠品（可选的未来行为）

**假设** 购物车已包含赠品（数量1）  
**并且** 已启用重复防止  
**并且** 用户添加主商品 + 相同赠品

**当** 执行购物车添加时

**那么** 系统跳过添加重复赠品  
**并且** 仅添加主商品  
**并且** 用户看到消息："赠品已在购物车中"

---

### 需求：按钮状态管理

**ID:** `GIFT-CART-011`  
**优先级:** 必须

在购物车添加期间，加入购物车按钮必须：
- 显示加载状态（禁用、旋转器或"正在添加..."文本）
- 防止多次同时提交
- 成功或错误后重新启用

#### 场景：购物车添加期间的加载状态

**假设** 用户点击"加入购物车"

**当** 购物车添加请求进行中时

**那么** 按钮显示"正在添加..."文本  
**并且** 按钮被禁用  
**并且** 按钮显示加载旋转器或指示器

**并且** 当请求完成（成功或错误）时  
**那么** 按钮返回正常状态  
**并且** 按钮重新启用

---

## 修改的需求

_此变更未修改现有购物车需求。_

---

## 删除的需求

_此变更未删除现有购物车需求。_

---

## 依赖项

此规格依赖于：
- `product-selection` 能力规格（用于赠品变体ID收集）
- Shopify购物车API（`/cart/add.js` 端点）
- Ajax购物车实现（如果主题中存在）

---

## 集成点

### 与产品选择的集成

购物车模块接收：
- 来自表单中 `input[name="id"]` 的主变体ID
- 来自表单中 `input[name="quantity"]` 的主数量
- 来自选中复选框的 `data-gift-variant-id` 属性的赠品变体ID

### 与Shopify购物车API的集成

请求格式：
```
POST /cart/add.js
Content-Type: application/json

{ "items": [ { "id": "variant-id", "quantity": N }, ... ] }
```

响应格式（成功）：
```json
{
  "items": [ { "id": ..., "quantity": ..., ... } ],
  "item_count": N,
  "total_price": X
}
```

响应格式（错误）：
```json
{
  "status": 422,
  "message": "错误消息",
  "description": "详细错误"
}
```

---

## 测试指导

### 测试场景

1. **单个赠品添加**：主商品 + 1个赠品 → 验证两者都在购物车中
2. **无赠品添加**：仅主商品 → 验证仅主商品在购物车中
3. **多个赠品**：主商品 + 2个赠品 → 验证所有3个商品都在购物车中
4. **数量变化**：主商品数量=5 + 赠品 → 验证赠品数量=1
5. **错误处理**：主商品缺货 → 验证显示错误，未添加任何商品
6. **网络错误**：模拟超时 → 验证错误处理
7. **购物车UI更新**：验证数量、抽屉和所有购物车指示器更新
8. **移除商品**：验证主商品和赠品的独立移除
9. **重复添加**：添加相同主商品+赠品两次 → 验证两次添加都有效

### API测试

模拟 `/cart/add.js` 响应：
- 成功：返回模拟商品数组
- 422错误：返回库存错误
- 500错误：返回服务器错误
- 网络超时：模拟请求超时

### 性能

- 带赠品的购物车添加应在< 1秒内完成（依赖网络）
- 按钮状态变化应立即（< 100ms）
- 购物车UI更新应在API响应后< 300ms内完成

---

## 未来增强

1. **链接商品**：移除主商品时自动移除赠品
2. **条件赠品**：基于购物车价值阈值显示赠品
3. **赠品数量限制**：防止多次添加相同赠品
4. **赠品替换**：如果稍后选择不同选项则交换赠品
5. **购物车加售**：如果选择了选项但未添加赠品，建议添加赠品
