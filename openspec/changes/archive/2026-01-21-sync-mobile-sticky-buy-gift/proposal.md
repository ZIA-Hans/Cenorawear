# 提案：同步移动端吸底加购按钮的赠品逻辑

**变更ID:** `sync-mobile-sticky-buy-gift`  
**状态:** 已实施  
**创建时间:** 2026-01-21  
**完成时间:** 2026-01-22

## 概述

本提案旨在为移动端吸底加购按钮（Sticky Buy Button）适配近期实现的“选项关联赠品”功能。目前，吸底按钮仅支持单个主商品的加购，当用户选择关联了赠品的选项值时，吸底按钮无法同步加购对应的赠品。本方案将在不破坏现有 SKU 切换和加购架构的前提下，实现吸底按钮与主表单赠品选择状态的同步，并确保加购时能正确处理多商品（主商品 + 赠品）。

## Why

1. **功能不一致**：主商品表单已支持赠品关联，但吸底按钮作为移动端核心购买入口，缺失此功能，导致用户在滚动页面后通过吸底按钮购买时无法获得赠品。
2. **用户困惑**：如果用户在页面上方选中了赠品，但在底部点击加购时只得到了主商品，会降低转化率并增加客服压力。
3. **技术缺口**：现有的 `ajaxCart` 逻辑依赖于 `form` ID 匹配，而吸底按钮使用了独立的 form ID，导致现有的赠品识别逻辑失效。

## What Changes

### 1. JavaScript 逻辑增强 (assets/custom-async.js)
- 扩展 `addCartItem` 中的赠品识别逻辑，支持带有 `-sticky` 后缀的表单 ID 匹配主表单的赠品单选按钮。

### 2. 吸底按钮组件适配 (snippets/product-sticky-buy-button.liquid)
- 增强 `MutationObserver` 逻辑，不仅同步主变体 ID，还需监测主表单中赠品单选按钮的选中状态。
- 在吸底按钮区域实时更新赠品相关的显示信息（如价格显示调整）。
- 确保吸底表单提交时，能够触发 `ajaxCart` 中的多商品加购流程。

## 范围

### 包含范围
- 移动端吸底加购按钮的加购流程适配。
- 主表单赠品选中状态向吸底按钮的同步。
- 兼容现有 `/cart/add.js` 的多商品提交逻辑。

### 不包含范围
- 桌面端布局调整（吸底按钮仅限移动端）。
- 更改主表单的赠品渲染逻辑。
- 更改现有的变体解析（Variant Discovery）逻辑。

## 成功标准
1. 在移动端选中关联赠品的选项后，点击吸底按钮，购物车应同时出现主商品和赠品。
2. 吸底按钮显示的加购价格应能反映选中赠品后的状态（如果赠品影响总价）。
3. 未选中赠品时，吸底按钮的加购逻辑保持原样，不受影响。
4. 切换变体后，吸底按钮的赠品关联状态依然正确同步。
