# 提案：添加选项关联赠品功能

**变更ID:** `add-option-gift-product-association`  
**状态:** 草案  
**创建时间:** 2026-01-14

## 概述

允许产品选项值与赠品SKU进行关联。当某个选项值与赠品关联后，该选项值不再以标准选项控件的形式展示，而是显示为可选择的赠品行。当用户选择赠品时，系统会同时将主商品变体（包含该选项值）和赠品一起加入购物车。

## 问题陈述

目前，Shopify产品选项选择仅限于标准UI控件（下拉菜单、按钮、色卡）。现有系统无法：

1. 将特定选项值与另一个商品（如免费赠品或配套商品）关联
2. 将该选项值显示为产品选择而非标准选项控件
3. 选择该选项时自动将多个SKU加入购物车
4. 当其他选项改变时保持正确的变体选择逻辑

**真实使用场景（戒指尺寸示例）：**
- 主商品：戒指，有"颜色"和"尺寸"两个选项
- 尺寸中有一个选项值"未确认尺寸"
- 当顾客选择"未确认尺寸"时，应该获赠一个免费的戒指指模套装
- UI应将指模套装显示为可选择的产品行，而非尺寸按钮
- 购物车应包含：戒指（选定颜色 + 未确认尺寸）+ 指模套装

## What Changes

### 解决方案

通过产品metafield实现选项值与赠品的关联配置系统，并相应调整UI和购物车行为。

### 核心能力

1. **配置管理**：在metafield中存储选项与赠品的关联关系
2. **产品选择UI**：将关联的赠品显示为可选择的产品行
3. **变体选择逻辑**：处理选项选择以正确更新当前变体
4. **购物车添加**：选择关联选项时，同时添加主变体和赠品SKU

### 核心行为

- **UI渲染**：关联的选项值从标准选项控件中隐藏，显示为产品行（含图片、标题和价格，通常为$0）
- **选择状态**：选择关联的产品行等同于设置相应的选项值为已选中，与该选项的其他值互斥
- **变体更新**：当其他选项改变时，系统正确解析到匹配关联选项值的变体
- **购物车添加**：提交时包含主商品变体ID和关联赠品变体ID
- **购物车行为**：两个SKU作为独立商品加入购物车，在购物车、结账等后续流程中自动正常显示，无需特殊处理
- **赠品数量**：赠品始终以数量1加入购物车，不受主商品数量影响

### 配置格式

使用产品metafield：`custom.option_gift_associations`

```json
{
  "associations": [
    {
      "option_name": "尺寸",
      "option_value": "未确认尺寸",
      "gift_product_handle": "ring-sizing-kit",
      "gift_variant_id": "40123456789"
    }
  ]
}
```

## 范围

### 包含范围
- 通过产品metafield配置关联关系
- 在变体选择区块中渲染关联赠品的UI
- 点击关联赠品时设置选项值的选择逻辑
- 混合选项选择时的变体解析
- 添加多个SKU到购物车
- 移动端和桌面端布局
- 快速购买（Quickshop）兼容性

### 不包含范围
- 配置关联的后台管理界面（初期手动编辑metafield）
- 每个选项值关联多个赠品（仅支持1:1关系）
- 关联本身之外的条件可见性规则
- 赠品库存检查和缺货处理（依赖Shopify标准购物车行为）
- 可自定义的赠品布局（仅单一标准布局）
- 购物车/结账中赠品的特殊显示逻辑（作为普通SKU处理）
- 主商品与赠品的关联移除逻辑（购物车中独立管理）
- 可配置的赠品数量（固定为1）

## 成功标准

1. 商家可以通过metafield配置选项-赠品关联
2. 关联的选项值从标准选项控件中隐藏
3. 关联的赠品显示为可选择的产品行
4. 选择关联赠品正确更新变体选择
5. 购物车同时接收主变体和赠品变体
6. 其他选项改变时变体更新正常工作
7. 功能在产品页和快速购买中均正常
8. 移动端UI功能正常且可访问

## 依赖项

- `sections/main-product.liquid` 中现有的变体选择逻辑
- `assets/custom-async.js` 中的JavaScript变体切换处理器
- 购物车添加机制（Ajax cart）
- Liquid中的产品metafield访问

## 风险与缓解措施

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 复杂的变体逻辑边界情况 | 高 | 全面测试各种选项组合 |
| 多SKU购物车添加失败 | 高 | 实现适当的错误处理和回滚 |
| 额外产品数据的性能影响 | 中 | 延迟加载赠品详情，在HTML中缓存 |
| 移动端UX复杂性 | 中 | 移动优先设计，真机测试 |
| 快速购买变体更新 | 中 | 确保AJAX更新包含赠品状态 |

## 关键决策

1. **赠品数量**：始终固定为1，不可配置
2. **缺货处理**：初期不做特殊处理，依赖Shopify购物车API的标准错误响应
3. **购物车/结账显示**：赠品作为独立SKU显示在购物车和结账流程中，自动同步，无需特殊逻辑
4. **UI指示器**：选中赠品即表示选中关联选项，与该选项的其他值互斥，不需要额外的视觉指示器
5. **购物车关联**：主商品和赠品在购物车中独立存在，移除一方不影响另一方

## 实施简化策略

为了加快首次实施并降低复杂度，采用以下简化策略：

1. **购物车即SKU**：赠品作为普通产品SKU处理，完全依赖Shopify标准购物车、结账和订单流程，无需开发特殊显示或处理逻辑
2. **后置库存检查**：不实现前端库存验证，依赖Shopify购物车API在添加时返回库存错误
3. **独立商品**：购物车中主商品和赠品完全独立，不实现智能关联移除
4. **标准UI**：使用原生HTML复选框，不添加自定义视觉增强

**优势：**
- 开发工作量减少约30%
- 更少的边缘情况需要处理
- 更容易维护和调试
- 与Shopify标准流程高度兼容

**未来可增强：**
- 添加赠品专属的购物车徽章/标签
- 实现前端库存检查
- 添加主商品与赠品的智能关联

## 考虑过的替代方案

1. **基于应用的解决方案**：更灵活但增加了依赖和成本
2. **产品捆绑**：不允许选项级别的细粒度控制
3. **手动cart.js操作**：可维护性差，没有选择UI
4. **自定义产品模板**：需要单独的产品，不可扩展

## 后续步骤

1. 审查并验证此提案
2. 创建详细的技术设计文档
3. 为每个能力编写规格增量
4. 创建实施任务列表
5. 在开发环境中实施和测试
6. 使用真实的戒指产品和指模套装场景进行验证
