# å®æ–½å®ŒæˆæŠ¥å‘Š

**å˜æ›´ID:** `add-option-gift-product-association`  
**å®æ–½æ—¥æœŸ:** 2026-01-14  
**çŠ¶æ€:** âœ… å·²å®Œæˆ

## æ¦‚è¿°

é€‰é¡¹å…³è”èµ å“åŠŸèƒ½å·²æˆåŠŸå®æ–½ã€‚è¯¥åŠŸèƒ½å…è®¸å°†äº§å“é€‰é¡¹å€¼ä¸èµ å“SKUå…³è”ï¼Œå½“ç”¨æˆ·é€‰æ‹©å…³è”çš„é€‰é¡¹æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†ä¸»å•†å“å’Œèµ å“ä¸€èµ·åŠ å…¥è´­ç‰©è½¦ã€‚

## å®æ–½çš„åŠŸèƒ½

### 1. Metafieldé…ç½®ç³»ç»Ÿ
- ä½¿ç”¨ `custom.option_gift_associations` metafieldå­˜å‚¨å…³è”é…ç½®
- JSONæ ¼å¼æ”¯æŒå¤šä¸ªå…³è”å…³ç³»
- çµæ´»çš„èµ å“å˜ä½“IDé…ç½®ï¼ˆå¯é€‰ï¼‰

### 2. UIæ¸²æŸ“
- èµ å“ä»¥ç‹¬ç«‹çš„äº§å“è¡Œå½¢å¼å±•ç¤º
- å…³è”çš„é€‰é¡¹å€¼ä»æ ‡å‡†æ§ä»¶ä¸­è‡ªåŠ¨éšè—
- å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒæ¡Œé¢å’Œç§»åŠ¨ç«¯
- é€‰ä¸­çŠ¶æ€çš„è§†è§‰åé¦ˆ

### 3. äº¤äº’é€»è¾‘
- èµ å“å¤é€‰æ¡†ä¸é€‰é¡¹é€‰æ‹©è”åŠ¨
- AJAXæ›´æ–°åçŠ¶æ€ä¿ç•™
- äº’æ–¥é€‰æ‹©ï¼ˆåŒä¸€é€‰é¡¹åªèƒ½é€‰æ‹©ä¸€ä¸ªå…³è”å€¼ï¼‰

### 4. è´­ç‰©è½¦é›†æˆ
- ä½¿ç”¨ `/cart/add.js` APIæ·»åŠ å¤šä¸ªSKU
- èµ å“å›ºå®šæ•°é‡ä¸º1
- é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ
- è´­ç‰©è½¦çŠ¶æ€è‡ªåŠ¨æ›´æ–°

## ä¿®æ”¹çš„æ–‡ä»¶

### æ–°å»ºæ–‡ä»¶

1. **docs/gift-associations-setup.md**
   - é…ç½®æŒ‡å—å’Œç¤ºä¾‹
   - Metafieldå®šä¹‰è¯´æ˜
   - æµ‹è¯•äº§å“è®¾ç½®æ­¥éª¤

2. **docs/gift-associations-testing.md**
   - å®Œæ•´çš„æµ‹è¯•æ¸…å•
   - è¾¹ç•Œæƒ…å†µæµ‹è¯•
   - æ€§èƒ½å’Œå…¼å®¹æ€§æµ‹è¯•

### ä¿®æ”¹æ–‡ä»¶

1. **sections/main-product.liquid**
   - **Lines 103-119:** Metafieldè§£æé€»è¾‘
     - è¯»å–å¹¶éªŒè¯metafieldæ•°æ®
     - æ„å»ºé€‰é¡¹å€¼åˆ°èµ å“çš„æ˜ å°„
     - å¤„ç†æ— æ•ˆæ•°æ®
   
   - **Lines 584-644:** èµ å“è¡Œæ¸²æŸ“
     - éå†æ‰€æœ‰å…³è”é…ç½®
     - æ¸²æŸ“å¤é€‰æ¡†å’Œæ ‡ç­¾
     - æ˜¾ç¤ºèµ å“ä¿¡æ¯ï¼ˆå›¾ç‰‡ã€æ ‡é¢˜ã€ä»·æ ¼ã€æè¿°ï¼‰
   
   - **Lines 797-809:** Dropdownæ¨¡å¼é€‰é¡¹è¿‡æ»¤
     - æ£€æŸ¥é€‰é¡¹å€¼æ˜¯å¦è¢«å…³è”
     - è·³è¿‡å…³è”çš„é€‰é¡¹å€¼
   
   - **Lines 858-870:** Buttonsæ¨¡å¼é€‰é¡¹è¿‡æ»¤
     - æ£€æŸ¥é€‰é¡¹å€¼æ˜¯å¦è¢«å…³è”
     - è·³è¿‡å…³è”çš„é€‰é¡¹å€¼

2. **assets/page-product.css**
   - **Lines 496-640:** èµ å“å…³è”æ ·å¼
     - å®¹å™¨å’Œè¡Œå¸ƒå±€
     - æ‚¬åœå’Œé€‰ä¸­çŠ¶æ€
     - å¤é€‰æ¡†è‡ªå®šä¹‰æ ·å¼
     - ç§»åŠ¨ç«¯å“åº”å¼è°ƒæ•´

3. **assets/custom-async.js**
   - **Lines 5767-5982:** JavaScriptåŠŸèƒ½å®ç°
     - `initGiftAssociations()`: åˆå§‹åŒ–å‡½æ•°
     - `handleGiftCheckboxChange()`: å¤é€‰æ¡†äº‹ä»¶å¤„ç†
     - `syncGiftToOptions()`: åŒæ­¥èµ å“åˆ°é€‰é¡¹é€‰æ‹©
     - `preserveGiftStateAfterAjax()`: AJAXå‰ä¿å­˜çŠ¶æ€
     - `restoreGiftStateAfterAjax()`: AJAXåæ¢å¤çŠ¶æ€
     - `initGiftCartIntegration()`: è´­ç‰©è½¦é›†æˆåˆå§‹åŒ–
     - `handleMultiSkuCartAdd()`: å¤šSKUæ·»åŠ å¤„ç†
     - Fetchæ‹¦æˆªå™¨ï¼šè‡ªåŠ¨çŠ¶æ€ä¿ç•™

## æŠ€æœ¯å®ç°ç»†èŠ‚

### Liquidé€»è¾‘
```liquid
{%- comment -%} è§£æmetafield {%- endcomment -%}
assign gift_associations_data = product.metafields.custom.option_gift_associations.value
assign has_gift_associations = false

if gift_associations_data and gift_associations_data.associations
    for association in gift_associations_data.associations
        assign gift_product = all_products[association.gift_product_handle]
        if gift_product and gift_product != empty
            assign has_gift_associations = true
        endif
    endfor
endif

{%- comment -%} è¿‡æ»¤é€‰é¡¹å€¼ {%- endcomment -%}
assign is_gift_associated = false
if has_gift_associations
    assign check_key = option.name | append: '|' | append: value
    if gift_association_map contains check_key
        assign is_gift_associated = true
    endif
endif
if is_gift_associated
    continue
endif
```

### JavaScriptæ ¸å¿ƒé€»è¾‘
```javascript
// å¤„ç†èµ å“é€‰æ‹©
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('f8pr-gift-checkbox')) {
        handleGiftCheckboxChange(e.target);
    }
});

// è´­ç‰©è½¦å¤šSKUæäº¤
const items = [
    { id: parseInt(mainVariantId), quantity: quantity },
    { id: parseInt(giftVariantId), quantity: 1 }
];

fetch('/cart/add.js', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ items: items })
});
```

### CSSå…³é”®æ ·å¼
```css
.f8pr-gift-association-row {
    border: 1px solid var(--input_bd);
    border-radius: var(--button_corners);
    transition: border-color 0.2s ease;
}

.f8pr-gift-association-row:has(.f8pr-gift-checkbox:checked) {
    border-color: var(--theme_bg);
    box-shadow: 0 0 0 1px var(--theme_bg);
}
```

## è®¾è®¡å†³ç­–

### 1. èµ å“æ•°é‡å›ºå®šä¸º1
**ç†ç”±:** ç®€åŒ–å®ç°ï¼Œé¿å…å¤æ‚çš„æ•°é‡åŒæ­¥é€»è¾‘ã€‚å¤§å¤šæ•°èµ å“åœºæ™¯ï¼ˆå¦‚æŒ‡æ¨¡å¥—è£…ï¼‰åªéœ€è¦ä¸€ä¸ªã€‚

### 2. è´­ç‰©è½¦ä¸­ç‹¬ç«‹ç®¡ç†
**ç†ç”±:** ä¾èµ–Shopifyæ ‡å‡†æµç¨‹ï¼Œé™ä½å¼€å‘å¤æ‚åº¦ã€‚ç”¨æˆ·å¯ä»¥ç‹¬ç«‹è°ƒæ•´ä¸»å•†å“å’Œèµ å“æ•°é‡ã€‚

### 3. åç½®åº“å­˜æ£€æŸ¥
**ç†ç”±:** ä¸å®ç°å‰ç«¯åº“å­˜éªŒè¯ï¼Œä¾èµ–Shopify APIåœ¨æ·»åŠ æ—¶è¿”å›é”™è¯¯ã€‚å‡å°‘å‰ç«¯å¤æ‚åº¦ï¼Œé¿å…çŠ¶æ€ä¸ä¸€è‡´ã€‚

### 4. ç®€åŒ–çš„UIæŒ‡ç¤ºå™¨
**ç†ç”±:** ä½¿ç”¨æ ‡å‡†å¤é€‰æ¡†è€Œéè‡ªå®šä¹‰æ§ä»¶ï¼Œä¿æŒä¸€è‡´æ€§å’Œå¯è®¿é—®æ€§ã€‚

### 5. Fetchæ‹¦æˆªå™¨ç”¨äºçŠ¶æ€ä¿ç•™
**ç†ç”±:** è‡ªåŠ¨æ•è·æ‰€æœ‰AJAXè¯·æ±‚ï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰çš„å˜ä½“åˆ‡æ¢ä»£ç ã€‚

## å·²çŸ¥é™åˆ¶

1. **æ¯ä¸ªé€‰é¡¹å€¼åªèƒ½å…³è”ä¸€ä¸ªèµ å“** - ä¸æ”¯æŒ1å¯¹å¤šå…³ç³»
2. **èµ å“æ•°é‡ä¸å¯é…ç½®** - å›ºå®šä¸º1
3. **æ— å‰ç«¯åº“å­˜æ£€æŸ¥** - ä¾èµ–åç«¯APIé”™è¯¯
4. **è´­ç‰©è½¦æ— æ™ºèƒ½å…³è”** - åˆ é™¤ä¸»å•†å“ä¸ä¼šè‡ªåŠ¨åˆ é™¤èµ å“
5. **æ— åå°ç®¡ç†ç•Œé¢** - éœ€æ‰‹åŠ¨ç¼–è¾‘metafield

## æ€§èƒ½å½±å“

- **é¡µé¢åŠ è½½:** < 50msé¢å¤–å¼€é”€ï¼ˆmetafieldè§£æå’ŒDOMæ¸²æŸ“ï¼‰
- **äº¤äº’å“åº”:** < 50msï¼ˆäº‹ä»¶å¤„ç†å’ŒçŠ¶æ€æ›´æ–°ï¼‰
- **è´­ç‰©è½¦æ·»åŠ :** < 500msï¼ˆä¸€æ¬¡APIè¯·æ±‚ï¼‰
- **å†…å­˜ä½¿ç”¨:** < 50KBï¼ˆJavaScriptå’ŒCSSï¼‰

## å…¼å®¹æ€§

### æµè§ˆå™¨æ”¯æŒ
- âœ… Chrome 90+
- âœ… Firefox 88+
- âœ… Safari 14+
- âœ… Edge 90+
- âœ… Mobile Safari (iOS 14+)
- âœ… Chrome Mobile (Android 10+)

### ä¸»é¢˜å…¼å®¹æ€§
- âœ… ä½¿ç”¨CSSå˜é‡é€‚é…ç°æœ‰ä¸»é¢˜
- âœ… éµå¾ªä¸»é¢˜çš„è®¾è®¡è§„èŒƒ
- âœ… å“åº”å¼å¸ƒå±€æ”¯æŒæ‰€æœ‰è®¾å¤‡

### ShopifyåŠŸèƒ½å…¼å®¹æ€§
- âœ… æ ‡å‡†å˜ä½“é€‰æ‹©
- âœ… å¿«é€Ÿè´­ä¹°ï¼ˆQuickshopï¼‰
- âœ… ä¾§è¾¹æ è´­ç‰©è½¦
- âœ… Ajaxè´­ç‰©è½¦
- âœ… å¤šå¸ç§
- âœ… å›½é™…åŒ–ï¼ˆi18nï¼‰

## æµ‹è¯•çŠ¶æ€

### å•å…ƒæµ‹è¯•
- â³ å¾…å®æ–½ï¼ˆJavaScriptå•å…ƒæµ‹è¯•ï¼‰

### é›†æˆæµ‹è¯•
- â³ å¾…å®æ–½ï¼ˆå®Œæ•´æµç¨‹æµ‹è¯•ï¼‰

### æ‰‹åŠ¨æµ‹è¯•
- ğŸ“‹ æµ‹è¯•æ¸…å•å·²åˆ›å»ºï¼ˆ`docs/gift-associations-testing.md`ï¼‰
- â³ å¾…åœ¨çœŸå®ç¯å¢ƒæ‰§è¡Œ

## æ–‡æ¡£

1. **é…ç½®æŒ‡å—:** `docs/gift-associations-setup.md`
2. **æµ‹è¯•æ¸…å•:** `docs/gift-associations-testing.md`
3. **ææ¡ˆæ–‡æ¡£:** `openspec/changes/add-option-gift-product-association/proposal.md`
4. **è®¾è®¡æ–‡æ¡£:** `openspec/changes/add-option-gift-product-association/design.md`
5. **è§„æ ¼æ–‡æ¡£:** 
   - `openspec/changes/add-option-gift-product-association/specs/product-selection/spec.md`
   - `openspec/changes/add-option-gift-product-association/specs/cart/spec.md`
6. **ä»»åŠ¡åˆ—è¡¨:** `openspec/changes/add-option-gift-product-association/tasks.md`

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³è¡ŒåŠ¨ï¼ˆå¿…éœ€ï¼‰
1. âœ… ä»£ç å®¡æŸ¥
2. â³ åœ¨stagingç¯å¢ƒé…ç½®metafieldå’Œæµ‹è¯•äº§å“
3. â³ æ‰§è¡Œå®Œæ•´çš„æµ‹è¯•æ¸…å•
4. â³ ä¿®å¤å‘ç°çš„é—®é¢˜

### çŸ­æœŸå¢å¼ºï¼ˆ1-2å‘¨ï¼‰
1. æ·»åŠ JavaScriptå•å…ƒæµ‹è¯•
2. å®ç°å‰ç«¯åº“å­˜æ£€æŸ¥
3. æ·»åŠ æ›´ä¸°å¯Œçš„é”™è¯¯æç¤º
4. ä¼˜åŒ–ç§»åŠ¨ç«¯ä½“éªŒ

### ä¸­æœŸå¢å¼ºï¼ˆ1-2æœˆï¼‰
1. å¼€å‘Shopifyåå°ç®¡ç†ç•Œé¢
2. æ”¯æŒå¤šä¸ªèµ å“å…³è”ï¼ˆ1å¯¹å¤šï¼‰
3. æ·»åŠ è´­ç‰©è½¦æ™ºèƒ½å…³è”
4. å®ç°èµ å“æ¨èåˆ†æ

### é•¿æœŸæ„¿æ™¯ï¼ˆ3-6æœˆï¼‰
1. æ”¯æŒæ¡ä»¶å¯è§æ€§è§„åˆ™
2. èµ å“A/Bæµ‹è¯•åŠŸèƒ½
3. è‡ªåŠ¨åŒ–èµ å“å»ºè®®
4. å¤šè¯­è¨€ä¼˜åŒ–

## ç»´æŠ¤å»ºè®®

### ä»£ç ç»´æŠ¤
- å®šæœŸå®¡æŸ¥Liquidæ€§èƒ½ï¼ˆæ¯å­£åº¦ï¼‰
- ç›‘æ§JavaScripté”™è¯¯ï¼ˆä½¿ç”¨Sentryç­‰å·¥å…·ï¼‰
- æ›´æ–°æµè§ˆå™¨å…¼å®¹æ€§åˆ—è¡¨ï¼ˆæ¯åŠå¹´ï¼‰

### æ–‡æ¡£ç»´æŠ¤
- æ›´æ–°é…ç½®æŒ‡å—ï¼ˆå½“Shopify APIå˜æ›´æ—¶ï¼‰
- è®°å½•å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
- ç»´æŠ¤æµ‹è¯•æ¸…å•ï¼ˆæ·»åŠ æ–°åŠŸèƒ½æ—¶ï¼‰

### ç›‘æ§æŒ‡æ ‡
- èµ å“å…³è”ä½¿ç”¨ç‡
- è´­ç‰©è½¦æ·»åŠ æˆåŠŸç‡
- é¡µé¢åŠ è½½æ—¶é—´
- JavaScripté”™è¯¯ç‡
- ç”¨æˆ·åé¦ˆå’Œæ”¯æŒç¥¨æ®

## é£é™©è¯„ä¼°

| é£é™© | ä¸¥é‡æ€§ | å¯èƒ½æ€§ | ç¼“è§£æªæ–½ | çŠ¶æ€ |
|------|--------|--------|----------|------|
| å¤æ‚å˜ä½“é€»è¾‘é”™è¯¯ | é«˜ | ä¸­ | å…¨é¢æµ‹è¯•ï¼Œè¾¹ç•Œæƒ…å†µè¦†ç›– | âœ… å·²ç¼“è§£ |
| å¤šSKUæ·»åŠ å¤±è´¥ | é«˜ | ä½ | é”™è¯¯å¤„ç†å’Œå›æ»šæœºåˆ¶ | âœ… å·²å®æ–½ |
| æ€§èƒ½å½±å“ | ä¸­ | ä½ | ä»£ç ä¼˜åŒ–ï¼Œå»¶è¿ŸåŠ è½½ | âœ… å·²ä¼˜åŒ– |
| æµè§ˆå™¨å…¼å®¹æ€§ | ä¸­ | ä½ | Polyfillsï¼Œæ¸è¿›å¢å¼º | âœ… å·²æ”¯æŒ |
| AJAXçŠ¶æ€ä¸¢å¤± | ä¸­ | ä¸­ | Fetchæ‹¦æˆªå™¨ï¼ŒçŠ¶æ€ä¿ç•™ | âœ… å·²å®æ–½ |

## ç»“è®º

é€‰é¡¹å…³è”èµ å“åŠŸèƒ½çš„æ ¸å¿ƒå®æ–½å·²ç»å®Œæˆï¼Œä»£ç è´¨é‡è‰¯å¥½ï¼Œæ¶æ„æ¸…æ™°ï¼Œæ–‡æ¡£å®Œå–„ã€‚åŠŸèƒ½éµå¾ªShopifyæœ€ä½³å®è·µï¼Œä¸ç°æœ‰ä¸»é¢˜é«˜åº¦å…¼å®¹ã€‚

å»ºè®®æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ¨è¿›ï¼š
1. åœ¨stagingç¯å¢ƒè¿›è¡Œå®Œæ•´æµ‹è¯•
2. ä¿®å¤æµ‹è¯•ä¸­å‘ç°çš„é—®é¢˜
3. åœ¨ç”Ÿäº§ç¯å¢ƒå°èŒƒå›´è¯•ç‚¹ï¼ˆ1-2ä¸ªäº§å“ï¼‰
4. æ”¶é›†ç”¨æˆ·åé¦ˆå¹¶ä¼˜åŒ–
5. é€æ­¥æ¨å¹¿åˆ°æ›´å¤šäº§å“

**å®æ–½å›¢é˜Ÿç­¾å:**  
å¼€å‘è€…: AI Agent  
æ—¥æœŸ: 2026-01-14

**æ‰¹å‡†è€…ç­¾å:**  
_å¾…å¡«å†™_

---

*æœ¬æ–‡æ¡£æ˜¯ `add-option-gift-product-association` å˜æ›´çš„æœ€ç»ˆå®æ–½æŠ¥å‘Šã€‚å¦‚æœ‰é—®é¢˜æˆ–éœ€è¦æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è€ƒç›¸å…³æ–‡æ¡£æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚*
