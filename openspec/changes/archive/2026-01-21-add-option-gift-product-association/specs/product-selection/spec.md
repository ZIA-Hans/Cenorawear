# 规格：赠品关联的产品选择

**能力:** `product-selection`  
**变更ID:** `add-option-gift-product-association`

## 概述

本规格定义了如何将产品选项值与赠品关联，以及这些关联如何影响产品选择用户界面和变体解析逻辑。

---

## ADDED

### Liquid模板渲染逻辑
- 在 `sections/main-product.liquid` 中添加赠品关联metafield解析
- 添加赠品产品行渲染（包含复选框、图片、标题、价格）
- 添加关联选项值从标准选项控件的过滤逻辑
- 添加必要的数据属性（data-option-name, data-option-value, data-gift-variant-id）

### CSS样式
- 在 `assets/gift-associations-styles.css` 中添加赠品卡片样式
- 添加移动端响应式布局样式
- 添加选中/未选中状态样式

### JavaScript选择逻辑
- 在 `assets/custom-async.js` 中添加赠品复选框事件处理器
- 添加赠品选择与选项值同步逻辑
- 添加变体解析时包含赠品设置的选项值
- 添加AJAX变体更新时的赠品状态保留

---

## MODIFIED

### 产品选项渲染
- 修改标准选项控件渲染逻辑以排除赠品关联的选项值

---

## 新增需求

### 需求：通过产品Metafield配置

**ID:** `GIFT-PS-001`  
**优先级:** 必须

系统必须支持通过产品metafield `custom.option_gift_associations` 配置选项-赠品关联，JSON结构如下：

```json
{
  "associations": [
    {
      "option_name": "string",
      "option_value": "string",
      "gift_product_handle": "string",
      "gift_variant_id": "string|null"
    }
  ]
}
```

**字段说明:**
- `option_name`: 必须匹配产品上现有的选项名称（区分大小写）
- `option_value`: 必须匹配该选项的现有值（区分大小写）
- `gift_product_handle`: 必须是有效的已发布产品handle
- `gift_variant_id`: 可选的变体ID；如果为null/省略，则使用第一个可用变体

#### 场景：有效的metafield配置

**假设** 产品的metafield `custom.option_gift_associations` 包含：
```json
{
  "associations": [
    {
      "option_name": "尺寸",
      "option_value": "未确认尺寸",
      "gift_product_handle": "ring-sizing-kit",
      "gift_variant_id": null
    }
  ]
}
```

**当** 产品页面加载时

**那么** 系统成功解析配置  
**并且** 关联关系可用于渲染

---

### 需求：从标准选项控件过滤关联值

**ID:** `GIFT-PS-002`  
**优先级:** 必须

系统必须将具有赠品关联的选项值从标准选项控件（下拉菜单、按钮、色卡）的渲染中排除。

#### 场景：从下拉菜单隐藏关联选项值

**假设** 产品有以下选项：
- 颜色: [黑色, 银色, 金色]
- 尺寸: [6, 7, 8, 未确认尺寸]

**并且** "未确认尺寸"与赠品关联

**当** 尺寸选项以下拉菜单形式渲染时

**那么** 下拉菜单仅包含 [6, 7, 8]  
**并且** "未确认尺寸"在下拉菜单中不可见

#### 场景：从按钮组隐藏关联选项值

**假设** 相同的产品和关联

**当** 尺寸选项以按钮形式渲染时

**那么** 仅显示 [6, 7, 8] 的按钮  
**并且** 不渲染"未确认尺寸"的按钮

---

### 需求：将赠品关联渲染为产品行

**ID:** `GIFT-PS-003`  
**优先级:** 必须

系统必须将每个赠品关联渲染为可选择的产品行，包含：
- 选择用的复选框输入
- 赠品图片
- 赠品标题
- 价格或"免费"标记
- 可选描述（截断）

产品行必须出现在其相关标准选项的上方或旁边。

#### 场景：渲染赠品产品行

**假设** 尺寸 = "未确认尺寸" 的赠品关联链接到"戒指指模套装"

**当** 产品页面渲染时

**那么** 显示赠品产品行，包含：
- "戒指指模套装"的特色图片
- 标题"戒指指模套装"
- "免费"标记（如果价格为0）
- 未选中状态的复选框

**并且** 该行出现在尺寸选项控件之前

#### 场景：不同选项的多个赠品关联

**假设** 关联：
- 尺寸 "未确认尺寸" → "戒指指模套装"
- 颜色 "定制" → "颜色样本套装"

**当** 产品页面渲染时

**那么** 两个赠品产品行都显示  
**并且** 每行都位于其相关选项控件附近

---

### 需求：赠品选择设置选项值

**ID:** `GIFT-PS-004`  
**优先级:** 必须

当用户选择赠品关联复选框时，系统必须：
1. 将关联的选项值设置为已选中
2. 取消选中同一选项的任何其他赠品关联
3. 使用选定的选项值触发变体解析

#### 场景：选择赠品关联复选框

**假设** 产品页面已加载  
**并且** 未选择尺寸选项

**当** 用户勾选"戒指指模套装"复选框（与尺寸 = "未确认尺寸"关联）

**那么** 尺寸选项值设置为"未确认尺寸"  
**并且** 使用组合选项值执行变体解析  
**并且** 赠品复选框保持选中状态

#### 场景：在同一选项的赠品关联之间切换

**假设** 尺寸有两个赠品关联：
- "未确认尺寸" → "戒指指模套装"
- "未知" → "尺寸咨询"

**并且** 当前选中"戒指指模套装"

**当** 用户勾选"尺寸咨询"

**那么** "戒指指模套装"自动取消选中  
**并且** 尺寸值更改为"未知"  
**并且** "尺寸咨询"保持选中状态

#### 场景：取消选择赠品关联

**假设** "戒指指模套装"已选中

**当** 用户取消选中它

**那么** 尺寸选项值被清除或恢复为第一个非赠品值  
**并且** 变体解析相应更新

---

### 需求：混合选择的变体解析

**ID:** `GIFT-PS-005`  
**优先级:** 必须

系统必须根据所有选定的选项值（包括由赠品关联设置的）正确解析产品变体ID，当：
- 初始页面加载
- 用户更改标准选项选择
- 用户更改赠品关联选择
- 两者的组合

#### 场景：解析选择了赠品选项的变体

**假设** 产品有以下变体：
- 黑色 + 尺寸 6 → 变体 A
- 黑色 + 未确认尺寸 → 变体 B
- 银色 + 未确认尺寸 → 变体 C

**并且** 用户已选择：
- 颜色: 黑色
- 赠品: 戒指指模套装（设置尺寸 = 未确认尺寸）

**当** 变体解析执行时

**那么** 系统解析为变体 B  
**并且** 变体 B 的ID设置在 `input[name="id"]` 中

#### 场景：在选择赠品的情况下更改标准选项

**假设** 当前选择：
- 颜色: 黑色（来自标准选项）
- 尺寸: 未确认尺寸（来自赠品复选框）
- 解析为: 变体 B

**当** 用户将颜色更改为银色

**那么** 系统保持尺寸 = 未确认尺寸  
**并且** 解析为变体 C（银色 + 未确认尺寸）  
**并且** 赠品复选框保持选中状态

#### 场景：在选择标准选项的情况下更改赠品选择

**假设** 当前选择：
- 颜色: 黑色
- 尺寸: 未确认尺寸（来自赠品）

**当** 用户取消选中赠品并从标准选项选择尺寸 = 7

**那么** 系统解析为黑色 + 尺寸 7 的变体  
**并且** 赠品复选框未选中

---

### 需求：AJAX变体更新保留赠品状态

**ID:** `GIFT-PS-006`  
**优先级:** 必须

当通过AJAX更新变体时（由选项更改触发），系统必须保留赠品关联选择状态并正确重新渲染赠品产品行。

#### 场景：AJAX更新期间保留赠品复选框状态

**假设** "戒指指模套装"赠品复选框已选中  
**并且** 颜色选项为黑色

**当** 用户将颜色更改为银色（触发AJAX变体更新）

**那么** AJAX响应包含更新的产品HTML  
**并且** 赠品产品行被重新渲染  
**并且** 重新渲染后"戒指指模套装"复选框保持选中  
**并且** 变体解析为银色 + 未确认尺寸

---

### 需求：快速购买模态框支持

**ID:** `GIFT-PS-007`  
**优先级:** 必须

赠品关联功能必须在快速购买模态框中工作，行为与完整产品页面相同。

#### 场景：快速购买中的赠品关联

**假设** 在快速购买模态框中打开产品

**当** 快速购买内容加载时

**那么** 赠品产品行正确渲染  
**并且** 赠品选择行为与产品页面匹配  
**并且** 变体解析正常工作

---

### 需求：移动端布局

**ID:** `GIFT-PS-008`  
**优先级:** 必须

赠品产品行必须响应式并在移动设备上正确显示：
- 触摸友好的复选框目标（最小44x44px）
- 无需水平滚动即可阅读的文本
- 图片适当缩放
- 如需要可堆叠布局

#### 场景：移动端赠品行显示

**假设** 在移动设备上查看产品页面（视口 < 768px）

**当** 赠品关联行渲染时

**那么** 每行以移动优化布局显示  
**并且** 复选框易于点击  
**并且** 产品图片可见但不过大  
**并且** 文本内容无需缩放即可阅读

---

### 需求：为JavaScript提供数据属性

**ID:** `GIFT-PS-009`  
**优先级:** 必须

赠品产品行元素必须包含JavaScript处理器所需的数据属性：
- `data-option-name`: 此关联影响的选项名称
- `data-option-value`: 此关联代表的选项值
- `data-gift-variant-id`: 要添加到购物车的赠品变体ID

#### 场景：赠品行上存在数据属性

**假设** 尺寸 = "未确认尺寸" → "戒指指模套装"（变体 12345）的赠品关联

**当** 赠品产品行渲染时

**那么** 行元素具有属性：
```html
data-option-name="尺寸"
data-option-value="未确认尺寸"
data-gift-variant-id="12345"
```

**并且** 这些属性可被JavaScript事件处理器访问

---

### 需求：错误处理 - 无效配置

**ID:** `GIFT-PS-010`  
**优先级:** 必须

系统必须优雅地处理无效的metafield配置，而不破坏产品页面：
- 缺少metafield：功能静默禁用
- 无效JSON：记录警告，功能禁用
- 选项名称不匹配：跳过该关联
- 找不到赠品：跳过该关联
- 无效的赠品变体ID：使用第一个可用变体

#### 场景：找不到赠品

**假设** metafield指定 `gift_product_handle: "non-existent-product"`

**当** 产品页面加载时

**那么** 跳过该关联  
**并且** 其他有效关联（如有）正确渲染  
**并且** 标准选项正常渲染

_注：初期实施不检查赠品库存状态，缺货情况在加入购物车时由Shopify API处理。_

#### 场景：选项名称不匹配

**假设** metafield指定 `option_name: "材质"`  
**但是** 产品仅有选项 [颜色, 尺寸]

**当** 产品页面加载时

**那么** 跳过该关联  
**并且** 不向用户显示错误  
**并且** 产品页面正常运行

---

### 需求：无障碍访问

**ID:** `GIFT-PS-011`  
**优先级:** 应该

赠品产品行应该对屏幕阅读器和键盘导航无障碍：
- 复选框有适当的标签关联
- 行有语义化的HTML结构
- 键盘Tab顺序符合逻辑
- 焦点指示器可见

#### 场景：键盘导航

**假设** 带赠品关联的产品页面

**当** 用户通过Tab键导航

**那么** 焦点按逻辑顺序移动通过赠品复选框  
**并且** Enter/空格键切换复选框选择  
**并且** 焦点指示器清晰可见

#### 场景：屏幕阅读器公告

**假设** "戒指指模套装 - 免费"的赠品产品行

**当** 屏幕阅读器聚焦于复选框

**那么** 它公告："戒指指模套装，免费，复选框，未选中"  
**并且** 选中它时公告："已选中"

---

## 修改的需求

_此变更未修改现有需求。_

---

## 删除的需求

_此变更未删除现有需求。_

---

## 依赖项

此规格依赖于：
- `cart` 能力规格（用于添加多个SKU到购物车）
- `main-product.liquid` 中现有的变体选择逻辑
- `custom-async.js` 中现有的AJAX变体更新

---

## 测试指导

### 测试数据设置

创建测试产品：
- **Handle**: `test-ring`
- **选项**: 颜色 [黑色, 银色]，尺寸 [6, 7, 未确认尺寸]
- **变体**: 所有组合（共6个变体）
- **Metafield**: `custom.option_gift_associations` 包含尺寸 "未确认尺寸" → "sizing-kit"

创建测试赠品：
- **Handle**: `sizing-kit`
- **价格**: $0.00
- **单个变体**

### 关键测试用例

1. **正常流程**：选择颜色，选择赠品，验证变体解析，加入购物车
2. **选项切换**：在选中赠品时更改标准选项
3. **赠品切换**：在同一选项的多个赠品之间切换
4. **AJAX更新**：验证变体更改期间的状态保留
5. **移动端**：在真实移动设备上测试
6. **错误情况**：使用无效metafield数据测试
7. **无障碍性**：使用键盘和屏幕阅读器测试

### 性能基准

- Metafield解析：< 5ms
- 赠品行渲染：每行 < 10ms
- 选择变更处理：< 50ms
- AJAX变体更新：< 500ms（依赖网络）
