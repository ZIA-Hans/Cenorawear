# 实施任务：选项关联赠品功能

**变更ID:** `add-option-gift-product-association`  
**状态:** ✅ 已完成  
**最后更新:** 2026-01-14  
**实施完成:** 2026-01-14

## 实施总结

所有核心功能已成功实施：

✅ **阶段1：基础** - Metafield模式已定义，配置文档已创建  
✅ **阶段2：Liquid实施** - metafield解析、选项过滤、赠品行渲染和CSS样式全部完成  
✅ **阶段3：JavaScript实施** - 赠品复选框事件处理和AJAX状态保留已实现  
✅ **阶段4：购物车集成** - 多SKU提交逻辑已完成  

### 已实施的文件

1. **docs/gift-associations-setup.md** - 新建：配置指南和示例
2. **sections/main-product.liquid** - 已修改：
   - Lines 103-119: Metafield解析逻辑
   - Lines 584-644: 赠品行渲染
   - Lines 797-809, 858-870: 选项值过滤（dropdown和buttons模式）
3. **assets/page-product.css** - 已修改：
   - Lines 496-640: 赠品关联样式（桌面和移动端）
4. **assets/custom-async.js** - 已修改：
   - Lines 5767-5982: 赠品关联JavaScript功能（事件处理、AJAX保留、购物车集成）

### 下一步操作

1. **在Shopify后台配置metafield**：按照 `docs/gift-associations-setup.md` 中的说明操作
2. **创建测试产品**：设置测试戒指和指模产品
3. **测试功能**：验证选项过滤、赠品选择和购物车添加
4. **调整样式**：根据需要微调CSS以匹配品牌

---

## 任务排序

任务按实施顺序组织。依赖关系在相关处注明。

### 关键实施原则

1. **赠品数量固定**：代码中硬编码赠品数量为1，无需额外验证或配置
2. **购物车简化**：赠品作为普通SKU添加到购物车，后续流程（购物车页、结账、订单）完全依赖Shopify标准逻辑，无需特殊处理
3. **库存检查简化**：初期不实现前端库存检查，加入购物车时由Shopify API返回标准错误
4. **独立管理**：购物车中的主商品和赠品完全独立，不实现关联移除逻辑
5. **最小化UI**：使用标准复选框表示选中状态，不添加额外视觉指示器

---

## 阶段1：基础（Metafield与配置）

### 任务 1.1：定义Metafield模式
**工作量:** 1小时  
**依赖:** 无  
**交付物:** Metafield定义文档

**步骤:**
1. 为 `custom.option_gift_associations` 创建metafield定义
2. 设置命名空间: `custom`，键: `option_gift_associations`
3. 设置类型: `json`
4. 记录预期的JSON模式结构
5. 为戒指 + 指模场景添加示例配置

**验证:**
- 可以在Shopify后台创建metafield
- JSON结构有效且可解析
- 示例数据加载无错误

---

### 任务 1.2：创建测试产品
**工作量:** 30分钟  
**依赖:** 任务 1.1  
**交付物:** 开发商店中的测试产品

**步骤:**
1. 创建主商品："测试戒指"，选项：
   - 颜色: 黑色、银色、金色
   - 尺寸: 6、7、8、未确认尺寸
2. 创建所有变体组合（12个变体）
3. 为变体设置价格和库存
4. 添加产品图片
5. 创建赠品："戒指指模套装"
   - 单个变体
   - 价格: $0.00
   - 添加产品图片和描述
6. 为"测试戒指"添加metafield，包含关联：
   ```json
   {
     "associations": [
       {
         "option_name": "尺寸",
         "option_value": "未确认尺寸",
         "gift_product_handle": "ring-sizing-kit",
         "gift_variant_id": null
       }
     ]
   }
   ```

**验证:**
- 两个产品都在店面可见
- Metafield数据在Liquid中可见（使用简单输出测试）
- 没有metafield功能时所有变体都可选

---

## 阶段2：Liquid实施（UI渲染）

### 任务 2.1：在产品模板中解析Metafield
**工作量:** 2小时  
**依赖:** 任务 1.2  
**交付物:** 可用的metafield解析逻辑  
**文件:** `sections/main-product.liquid`

**步骤:**
1. 在liquid变量区段添加metafield读取逻辑（lines ~17-104）
   ```liquid
   assign gift_associations = product.metafields.custom.option_gift_associations.value
   ```
2. 添加验证：检查metafield是否存在且有associations数组
3. 创建查找结构，将选项名称+值映射到赠品
4. 遍历关联并使用 `all_products[handle]` 获取赠品
5. 优雅处理缺少的赠品（跳过关联）
6. 将解析的关联存储在区块可访问的变量中

**验证:**
- 如果缺少metafield，Liquid不抛出错误
- Liquid正确识别有效关联
- 无效关联（错误handle、缺少产品）被跳过
- 使用 `{{ gift_associations | json }}` 检查解析的数据

---

### 任务 2.2：从选项控件过滤关联值
**工作量:** 3小时  
**依赖:** 任务 2.1  
**交付物:** 标准控件中隐藏关联的选项值  
**文件:** `sections/main-product.liquid`（variant_selection区块，lines ~520-878）

**步骤:**
1. 在variant_selection区块中，渲染选项之前：
   - 为每个选项名称创建关联选项值的数组
2. 修改选项渲染循环（下拉菜单和按钮）：
   - 检查当前值是否在关联值数组中
   - 如果关联则跳过渲染（`{% unless is_associated %}`）
3. 测试下拉选择类型
4. 测试按钮选择类型
5. 确保其他选项值仍然正确渲染

**验证:**
- "未确认尺寸"选项在下拉菜单中不可见
- "未确认尺寸"按钮不渲染
- 其他尺寸选项（6、7、8）仍正确显示
- 颜色选项不受影响
- 非关联选项的变体选择仍然有效

---

### 任务 2.3：渲染赠品行
**工作量:** 4小时  
**依赖:** 任务 2.2  
**交付物:** 赠品行正确显示  
**文件:** `sections/main-product.liquid`（variant_selection区块）

**步骤:**
1. 在标准选项之前的variant_selection区块创建新区段
2. 添加容器div，类名 `f8pr-gift-associations`
3. 遍历赠品关联：
   ```liquid
   {% for association in gift_associations.associations %}
   ```
4. 对于每个关联：
   - 使用handle获取赠品
   - 获取赠品变体（使用指定ID或第一个可用）
   - 渲染复选框输入，包含：
     - 基于选项名称 + 值的唯一ID
     - 类 `f8pr-gift-checkbox`
     - 数据属性：`data-option-name`、`data-option-value`、`data-gift-variant-id`
     - 链接到购买按钮表单的form属性
   - 渲染标签，包含：
     - 赠品图片（60px宽度）
     - 赠品标题
     - 价格或"免费"标记（如果价格 = 0）
     - 截断的描述
     - 选中标记图标/指示器
5. 将赠品行定位在相关选项控件上方

**验证:**
- 赠品行在产品页面显示
- 图片正确加载
- 标题和"免费"标记可见
- 复选框功能正常（可以手动选中/取消选中）
- 行出现在尺寸选项控件上方

---

### 任务 2.4：为赠品行添加CSS样式
**工作量:** 2小时  
**依赖:** 任务 2.3  
**交付物:** 样式化的赠品行  
**文件:** 创建 `assets/gift-associations.css` 或添加到现有CSS

**步骤:**
1. 为 `.f8pr-gift-associations` 组件创建样式表
2. 样式化赠品行：
   - Flexbox布局：图片 | 内容 | 复选框
   - 内边距和间距
   - 边框或背景以示区别
   - 悬停状态
3. 样式化选中状态：
   - 高亮边框或背景
   - 选中标记可见
4. 样式化赠品信息：
   - 标题字体大小和粗细
   - 免费标记样式（颜色、背景）
   - 描述文本样式
5. 添加移动响应式样式：
   - 如需要可堆叠布局
   - 触摸友好的复选框大小（最小44px）
   - 无需缩放即可阅读的文本
6. 在theme.liquid或section中链接样式表

**验证:**
- 赠品行看起来精致专业
- 匹配主题设计语言
- 移动布局在真实设备上有效
- 悬停和选中状态清晰
- 免费标记适当突出

---

## 阶段3：JavaScript实施（交互逻辑）

### 任务 3.1：添加赠品复选框事件监听器
**工作量:** 3小时  
**依赖:** 任务 2.3  
**交付物:** 赠品复选框触发选项选择  
**文件:** `assets/custom-async.js`（productVariantsAsync函数，lines ~5068-5327）

**步骤:**
1. 在 `productVariantsAsync` 函数中，选择所有 `.f8pr-gift-checkbox` 元素
2. 为每个复选框添加 `change` 事件监听器
3. 复选框改变时（选中）：
   - 读取 `data-option-name` 和 `data-option-value`
   - 找到对应的选项输入（隐藏或可见）：
     - 对于下拉菜单：找到 `<select>` 并设置其值
     - 对于单选按钮：找到匹配的radio并设置checked
     - 对于隐藏输入：直接设置值
   - 在选项输入上触发 `change` 事件以启动变体解析
   - 取消选中同一选项的其他赠品复选框
4. 复选框改变时（取消选中）：
   - 可选择性地恢复到第一个非赠品值（或保持未选择）
5. 添加 `.listening` 类以防止重复监听器

**验证:**
- 选中赠品复选框将尺寸选项设置为"未确认尺寸"
- 变体正确解析（例如，黑色 + 未确认尺寸）
- 价格更新为正确的变体价格
- 图片更新（如果变体有不同图片）
- 控制台没有JavaScript错误

---

### 任务 3.2：在AJAX更新期间保留赠品状态
**工作量:** 3小时  
**依赖:** 任务 3.1  
**交付物:** 变体更改时保留赠品复选框状态  
**文件:** `assets/custom-async.js`（productVariantsAsync函数）

**步骤:**
1. AJAX变体更新之前，捕获当前赠品复选框状态：
   ```javascript
   const giftCheckboxStates = Array.from(document.querySelectorAll('.f8pr-gift-checkbox'))
     .map(cb => ({ id: cb.id, checked: cb.checked }));
   ```
2. AJAX更新和DOM替换后：
   - 重新查询 `.f8pr-gift-checkbox` 元素（它们是新的DOM节点）
   - 基于保存的状态恢复选中状态
   - 重新附加事件监听器（调用 `productVariantsAsync()`）
3. 确保AJAX响应HTML中的赠品复选框具有正确的checked属性
   - 这可能需要服务器端逻辑根据URL参数设置checked

**验证:**
- 选中"未确认尺寸"的赠品复选框
- 更改颜色选项（触发AJAX）
- 页面更新后，赠品复选框仍然选中
- 变体仍然解析为新颜色 + 未确认尺寸
- AJAX更新后可以取消选中和重新选中赠品

---

### 任务 3.3：处理多个赠品关联
**工作量:** 2小时  
**依赖:** 任务 3.1  
**交付物:** 不同选项的多个赠品正常工作  
**文件:** `assets/custom-async.js`

**步骤:**
1. 测试包含2+个赠品关联的场景（例如，尺寸 + 颜色）
2. 确保每个赠品复选框正确设置其选项
3. 确保不同选项的赠品可以同时选中
4. 确保同一选项的赠品互斥（取消选中其他）
5. 验证具有多个赠品设置选项的变体解析

**验证:**
- 创建包含2个赠品关联的测试产品
- 选中两个赠品
- 验证两个选项都正确设置
- 验证变体正确解析
- 取消选中一个赠品，验证选项更新

---

## 阶段4：购物车集成

### 任务 4.1：表单提交时收集赠品变体ID
**工作量:** 2小时  
**依赖:** 任务 3.2  
**交付物:** 正确收集赠品变体ID  
**文件:** `assets/custom-async.js`（购物车添加逻辑）

**步骤:**
1. 找到现有的加入购物车表单提交处理器或AJAX购物车代码
2. 拦截表单提交事件
3. 从 `input[name="id"]` 读取主变体ID
4. 从 `input[name="quantity"]` 读取数量
5. 查询所有选中的 `.f8pr-gift-checkbox` 元素
6. 对于每个选中的赠品：
   - 从父行读取 `data-gift-variant-id`
   - 添加到赠品变体ID数组
7. 构建items数组：
   ```javascript
   const items = [
     { id: mainVariantId, quantity: parseInt(quantity) }
   ];
   giftVariantIds.forEach(id => {
     items.push({ id: id, quantity: 1 });
   });
   ```
8. 记录items数组以便调试

**验证:**
- 选择主变体 + 赠品，点击加入购物车
- 控制台记录正确的items数组：
  ```javascript
  [
    { id: "99999", quantity: 1 },
    { id: "12345", quantity: 1 }
  ]
  ```
- 测试未选择赠品（items数组仅有主变体）
- 测试多个赠品（items数组有主商品 + 所有赠品）

---

### 任务 4.2：提交多商品购物车请求
**工作量:** 3小时  
**依赖:** 任务 4.1  
**交付物:** 多个商品成功加入购物车  
**文件:** `assets/custom-async.js`

**步骤:**
1. 将单商品购物车添加替换为多商品请求：
   ```javascript
   fetch('/cart/add.js', {
     method: 'POST',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify({ items: items })
   })
   ```
2. 处理响应：
   - 解析JSON响应
   - 检查错误（状态、消息）
   - 提取添加的商品和购物车数据
3. 成功时：
   - 调用现有购物车更新函数（如果主题有AJAX购物车）
   - 更新页眉购物车数量
   - 显示成功消息或打开购物车抽屉
4. 错误时：
   - 向用户显示错误消息
   - 重新启用加入购物车按钮
   - 记录错误详情以便调试

**验证:**
- 将主商品 + 赠品加入购物车
- 验证Shopify响应成功
- 验证两个商品都出现在购物车中（检查 `/cart.json`）
- 验证购物车数量正确更新（2个商品）
- 验证购物车抽屉显示两个商品（如适用）

---

### 任务 4.3：处理购物车添加错误
**工作量:** 2小时  
**依赖:** 任务 4.2  
**交付物:** 带用户反馈的错误处理  
**文件:** `assets/custom-async.js`

**步骤:**
1. 测试错误场景：
   - 主商品缺货
   - 赠品缺货
   - 无效变体ID
   - 网络超时
2. 对于每个错误：
   - 从Shopify响应解析错误消息
   - 显示用户友好的错误消息
   - 不更新购物车UI
   - 重新启用加入购物车按钮
3. 实施错误消息显示：
   - 如果可用，使用现有主题通知系统
   - 或创建简单的模态框/警报
4. 记录详细错误到控制台以便调试

**验证:**
- 将主商品库存设置为0，尝试添加 → 看到错误消息
- 将赠品设置为禁用，尝试添加 → 看到错误消息
- 模拟网络错误 → 看到超时消息
- 所有错误显示用户友好的消息
- 错误时购物车保持不变

---

### 任务 4.4：添加后更新购物车UI
**工作量:** 2小时  
**依赖:** 任务 4.2  
**交付物:** 购物车UI反映新商品  
**文件:** `assets/custom-async.js`，可能还有购物车抽屉模板

**步骤:**
1. 识别所有需要更新的购物车UI元素：
   - 页眉购物车数量
   - 购物车图标徽章
   - 购物车抽屉/弹出窗口（如果主题有）
   - 迷你购物车小部件
2. 成功加入购物车后：
   - 获取更新的购物车数据（`/cart.js`）
   - 更新购物车数量：`response.item_count`
   - 如果存在抽屉：刷新抽屉HTML或更新行项目
3. 如果存在，测试主题现有的AJAX购物车
4. 确保没有重复更新（避免重复计数）

**验证:**
- 添加主商品 + 赠品，验证数量增加2
- 购物车抽屉显示两个行项目，带图片和标题
- 点击购物车图标显示更新的购物车
- 刷新页面显示正确的购物车状态

---

## 阶段5：测试与优化

### 任务 5.1：跨浏览器测试
**工作量:** 3小时  
**依赖:** 所有之前的任务  
**交付物:** 功能在主要浏览器中工作

**步骤:**
1. 在Chrome（最新版）上测试
2. 在Firefox（最新版）上测试
3. 在Safari（最新版）上测试
4. 在Edge（最新版）上测试
5. 在移动Safari（iOS）上测试
6. 在Chrome移动版（Android）上测试
7. 记录任何浏览器特定问题
8. 应用兼容性问题的修复

**验证:**
- 赠品复选框在所有浏览器中正确渲染
- 选择逻辑在所有浏览器中工作
- 购物车添加在所有浏览器中成功
- 样式看起来一致（在可接受的差异范围内）
- 移动触摸交互平滑工作

---

### 任务 5.2：移动响应式测试
**工作量:** 2小时  
**依赖:** 任务 2.4，任务 5.1  
**交付物:** 移动UX功能正常且可访问

**步骤:**
1. 在真实移动设备上测试：
   - iPhone（iOS 15+）
   - Android手机（Chrome）
2. 测试竖屏和横屏方向
3. 验证触摸目标足够大（最小44x44px）
4. 验证文本无需缩放即可阅读
5. 验证图片适当缩放
6. 在平板上测试（iPad、Android平板）
7. 修复任何移动特定的布局问题

**验证:**
- 赠品行在移动端清晰显示
- 复选框易于点击
- 不需要水平滚动
- 所有文本清晰可读
- 图片不溢出或破坏布局

---

### 任务 5.3：无障碍测试
**工作量:** 2小时  
**依赖:** 所有之前的任务  
**交付物:** 功能对屏幕阅读器和键盘用户无障碍

**步骤:**
1. 测试键盘导航：
   - 通过Tab键浏览赠品复选框
   - 使用空格/回车切换复选框
   - 验证焦点指示器可见
2. 使用屏幕阅读器测试（NVDA、JAWS或VoiceOver）：
   - 验证复选框标签正确读取
   - 验证赠品信息被宣告
   - 验证选择状态变化被宣告
3. 检查HTML语义：
   - 正确的标签关联（`for` 属性）
   - 如需要适当的ARIA属性
   - 语义化标题结构
4. 测试高对比度模式
5. 修复发现的任何无障碍问题

**验证:**
- 键盘用户可以无需鼠标选择赠品
- 屏幕阅读器宣告："戒指指模套装，免费，复选框，未选中"
- 选中赠品宣告："已选中"
- 焦点指示器清晰可见
- 浏览器开发工具中没有无障碍警告

---

### 任务 5.4：快速购买集成测试
**工作量:** 3小时  
**依赖:** 所有之前的任务  
**交付物:** 功能在快速购买模态框中工作

**步骤:**
1. 在快速购买模态框中打开产品（如果主题支持）
2. 验证赠品行正确渲染
3. 验证赠品选择逻辑工作
4. 验证变体通过AJAX更新工作
5. 验证购物车添加包含赠品
6. 测试移动快速购买（如果与桌面版不同）
7. 修复任何快速购买特定的问题

**验证:**
- 快速购买显示赠品行
- 在快速购买中选择赠品更新变体
- 从快速购买加入购物车包含赠品
- 关闭并重新打开快速购买保持状态
- 移动快速购买正常工作

---

### 任务 5.5：边缘情况测试
**工作量:** 3小时  
**依赖:** 所有之前的任务  
**交付物:** 边缘情况得到优雅处理

**测试场景:**
1. **无metafield**：没有metafield的产品正常显示
2. **空关联数组**：功能禁用，无错误
3. **无效JSON**：功能禁用，记录错误
4. **赠品被删除**：跳过关联，其他功能工作
5. **选项名称不匹配**：跳过关联
6. **赠品缺货**：前端正常显示，加入购物车时由Shopify API返回库存错误
7. **多个访客同时访问**：购物车无冲突
8. **达到购物车限制**：适当的错误处理
9. **非常长的赠品名称**：UI不破坏
10. **缺少赠品图片**：显示占位符或无图片

_注：赠品库存检查不在初期范围内，依赖Shopify购物车API的标准错误响应。_

**验证:**
- 记录每个边缘情况的预期行为
- 验证实际行为符合预期
- 修复任何意外行为或崩溃
- 确保错误消息清晰有用

---

### 任务 5.6：性能测试
**工作量:** 2小时  
**依赖:** 所有之前的任务  
**交付物:** 功能在可接受限制内执行

**要测试的指标:**
1. 页面加载时间增加（应 < 100ms）
2. Metafield解析时间（应 < 5ms）
3. 赠品行渲染时间（每行应 < 10ms）
4. JavaScript事件处理器响应时间（应 < 50ms）
5. 购物车添加请求时间（依赖网络，通常 < 500ms）
6. AJAX变体更新时间（不应明显变慢）

**步骤:**
1. 使用浏览器开发工具性能选项卡
2. 测量基线（没有功能的产品）
3. 测量启用功能后的性能
4. 比较指标
5. 如果任何指标超过目标则优化

**验证:**
- 选中赠品复选框时没有明显延迟
- 购物车添加感觉即时或接近即时
- 页面加载时间没有显著影响
- 控制台没有性能警告

---

## 阶段6：文档与部署

### 任务 6.1：创建开发者文档
**工作量:** 2小时  
**依赖:** 所有之前的任务  
**交付物:** 商家和开发者文档

**步骤:**
1. 记录metafield模式和示例
2. 记录如何配置关联
3. 记录预期行为
4. 记录已知限制
5. 包含配置和UI的截图
6. 创建故障排除指南
7. 添加FAQ部分

**交付物:**
- `docs/gift-associations-setup.md`
- 包含在主题文档或README中

---

### 任务 6.2：Staging部署
**工作量:** 1小时  
**依赖:** 所有之前的任务  
**交付物:** 功能在staging环境中上线

**步骤:**
1. 将所有代码更改部署到staging主题
2. 使用metafield配置测试产品
3. 运行完整用户旅程：
   - 浏览到产品
   - 选择赠品
   - 加入购物车
   - 查看购物车
   - 进入结账（不完成）
4. 从多个设备测试
5. 获得利益相关者批准

**验证:**
- Staging工作与开发测试完全一致
- 类生产环境中没有控制台错误
- 利益相关者可以测试并提供反馈

---

### 任务 6.3：生产部署
**工作量:** 1小时  
**依赖:** 任务 6.2  
**交付物:** 功能在生产环境中上线

**步骤:**
1. 备份当前主题
2. 部署到生产主题
3. 在戒指产品上配置metafield，包含指模关联
4. 测试实时产品页面：
   - 验证赠品显示
   - 进行测试购买
   - 验证订单包含两个商品
5. 监控错误（JavaScript控制台、服务器日志）
6. 监控赠品选择率的分析数据
7. 检查支持工单是否有任何问题

**验证:**
- 生产部署成功
- 戒指 + 指模关联实时工作
- 真实客户可以选择和购买赠品
- 错误率或支持工单没有增加
- 分析显示赠品选择正在发生

---

### 任务 6.4：监控与迭代
**工作量:** 持续  
**依赖:** 任务 6.3  
**交付物:** 功能得到维护和改进

**持续活动:**
1. 监控分析：
   - 赠品选择率
   - 有无赠品的购物车放弃率
   - 转化率影响
2. 监控错误：
   - 错误跟踪工具中的JavaScript错误
   - 购物车添加失败
   - 与功能相关的支持工单
3. 收集用户反馈：
   - 客户调查
   - 用户测试会话
   - 支持工单主题
4. 计划迭代：
   - 基于反馈改进UI
   - 添加请求的功能
   - 优化性能

---

## 任务摘要

| 阶段 | 任务数 | 预计工作量 |
|------|-------|-----------|
| 阶段1：基础 | 2个任务 | 1.5小时 |
| 阶段2：Liquid实施 | 4个任务 | 11小时 |
| 阶段3：JavaScript实施 | 3个任务 | 8小时 |
| 阶段4：购物车集成 | 4个任务 | 9小时 |
| 阶段5：测试与优化 | 6个任务 | 15小时 |
| 阶段6：文档与部署 | 4个任务 | 4+小时 |
| **总计** | **23个任务** | **~48.5小时** |

---

## 并行化机会

可以并行执行的任务：
- 任务 2.3（HTML）完成后，任务 2.4（CSS）可以开始
- 任务 5.1、5.2、5.3 可以由不同测试人员并行执行
- 当任务 5.x 测试正在进行时，文档（6.1）可以编写

---

## 依赖关系图

```
1.1 (Metafield模式)
  └─ 1.2 (测试产品)
      └─ 2.1 (解析Metafield)
          └─ 2.2 (过滤选项)
              └─ 2.3 (渲染赠品行)
                  ├─ 2.4 (CSS样式)
                  └─ 3.1 (事件监听器)
                      └─ 3.2 (AJAX保留)
                          └─ 3.3 (多个赠品)
                              └─ 4.1 (收集ID)
                                  └─ 4.2 (提交到购物车)
                                      ├─ 4.3 (错误处理)
                                      └─ 4.4 (更新UI)
                                          └─ 5.1-5.6 (测试)
                                              └─ 6.1 (文档)
                                                  └─ 6.2 (Staging)
                                                      └─ 6.3 (生产)
                                                          └─ 6.4 (监控)
```

---

## 风险缓解

高风险任务：
- **任务 3.2（AJAX保留）**：复杂的状态管理
  - 缓解：全面测试，如需要可回退到页面重新加载
- **任务 4.2（多商品购物车）**：依赖Shopify API行为
  - 缓解：在staging中彻底测试，准备好错误处理
- **任务 5.4（快速购买）**：主题特定的实现各不相同
  - 缓解：尽早测试，每个主题可能需要自定义解决方案

---

## 成功指标

- 完成所有23个任务
- 满足所有验证标准
- 生产中零P0/P1错误
- 符合条件的产品查看的赠品选择率 > 10%
- 购物车放弃率没有增加
- 与功能相关的支持工单每周 < 1个
