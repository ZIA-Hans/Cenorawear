# 赠品关联功能测试清单

## 测试环境准备

### 1. 配置Metafield
- [ ] 在Shopify后台创建 `custom.option_gift_association` metafield
- [ ] 验证metafield类型为JSON

### 2. 创建测试产品

**主商品：测试戒指**
- [ ] 创建产品，handle: `test-ring`
- [ ] 添加选项"颜色"：黑色、银色、金色
- [ ] 添加选项"尺寸"：6、7、8、未确认尺寸
- [ ] 确保所有12个变体都已创建
- [ ] 上传产品图片

**赠品：戒指指模套装**
- [ ] 创建产品，handle: `ring-sizing-kit`
- [ ] 只有一个变体
- [ ] 价格设为 $0.00
- [ ] 上传产品图片
- [ ] 添加产品描述

### 3. 配置关联
- [ ] 为"测试戒指"添加metafield值：
```json
{
  "associations": [
    {
      "option_name": "尺寸",
      "option_value": "未确认尺寸",
      "gift_product_handle": "ring-sizing-kit",
      "gift_variant_id": null
    }
  ]
}
```

---

## 功能测试

### 阶段1：UI渲染测试

**测试1.1：赠品行显示**
- [ ] 访问测试戒指产品页面
- [ ] 确认看到"戒指指模套装"赠品行
- [ ] 验证赠品行位置在尺寸选项上方
- [ ] 确认显示赠品图片
- [ ] 确认显示"免费"标记（价格为$0）
- [ ] 确认显示产品描述（截断）

**测试1.2：选项过滤**
- [ ] 检查尺寸选项区域
- [ ] 确认"未确认尺寸"选项不显示为按钮/下拉选项
- [ ] 确认其他尺寸（6、7、8）正常显示
- [ ] 确认颜色选项不受影响

**测试1.3：样式检查**
- [ ] 桌面端：赠品行布局正确（水平排列：图片-信息-复选框）
- [ ] 桌面端：悬停时边框变色
- [ ] 移动端：布局适配正确
- [ ] 移动端：触摸区域足够大
- [ ] 移动端：描述文本隐藏（如设计）

---

### 阶段2：交互测试

**测试2.1：赠品选择**
- [ ] 点击赠品行选中复选框
- [ ] 确认复选框显示选中状态
- [ ] 确认赠品行高亮显示（边框加深、背景色变化）
- [ ] 再次点击取消选中
- [ ] 确认状态正确切换

**测试2.2：选项联动**
- [ ] 选中赠品复选框
- [ ] 查看浏览器URL是否更新（应包含对应的variant参数）
- [ ] 检查产品价格是否更新为对应变体的价格
- [ ] 选择一个颜色选项（例如"黑色"）
- [ ] 确认页面显示的是"黑色 + 未确认尺寸"变体

**测试2.3：AJAX更新测试**
- [ ] 选中赠品复选框
- [ ] 切换颜色选项
- [ ] 确认赠品复选框状态保持选中
- [ ] 切换到其他尺寸选项（例如"7"）
- [ ] 切换回颜色
- [ ] 确认赠品复选框状态正确恢复

---

### 阶段3：购物车测试

**测试3.1：基本添加**
- [ ] 选中赠品复选框
- [ ] 选择颜色"黑色"
- [ ] 点击"加入购物车"按钮
- [ ] 确认看到成功提示消息
- [ ] 确认购物车数量更新为2
- [ ] 打开购物车查看内容

**测试3.2：购物车内容验证**
- [ ] 确认购物车包含"测试戒指"（黑色 / 未确认尺寸）
- [ ] 确认购物车包含"戒指指模套装"
- [ ] 确认两个商品是独立的行项目
- [ ] 确认指模套装价格为$0.00
- [ ] 确认指模套装数量为1

**测试3.3：数量测试**
- [ ] 清空购物车
- [ ] 在产品页面将主商品数量改为3
- [ ] 选中赠品并添加到购物车
- [ ] 确认主商品数量为3
- [ ] 确认赠品数量仍为1（不受主商品数量影响）

**测试3.4：错误处理**
- [ ] 尝试添加缺货的赠品（如有）
- [ ] 确认看到适当的错误消息
- [ ] 确认购物车状态未损坏

---

### 阶段4：边界情况测试

**测试4.1：无赠品配置**
- [ ] 创建一个没有metafield的新产品
- [ ] 访问产品页面
- [ ] 确认页面正常加载
- [ ] 确认没有赠品行显示
- [ ] 确认所有选项正常显示和工作

**测试4.2：无效赠品handle**
- [ ] 修改metafield，使用不存在的产品handle
- [ ] 刷新产品页面
- [ ] 确认页面不崩溃
- [ ] 确认无效关联被忽略
- [ ] 确认其他有效关联（如有）仍然工作

**测试4.3：多个关联**
- [ ] 修改metafield添加第二个关联（如果适用）
- [ ] 确认两个赠品行都显示
- [ ] 确认同一选项只能选中一个赠品
- [ ] 确认选中第二个赠品会取消第一个

**测试4.4：已选中赠品的移除**
- [ ] 选中赠品并添加到购物车
- [ ] 在购物车中删除主商品
- [ ] 确认赠品仍然保留（独立管理）
- [ ] 在购物车中删除赠品
- [ ] 确认主商品仍然保留

---

### 阶段5：兼容性测试

**测试5.1：浏览器兼容性**
- [ ] Chrome（最新版本）
- [ ] Firefox（最新版本）
- [ ] Safari（最新版本）
- [ ] Edge（最新版本）
- [ ] Mobile Safari（iOS）
- [ ] Chrome Mobile（Android）

**测试5.2：快速购买（Quickshop）**
- [ ] 在集合页面打开快速购买弹窗
- [ ] 确认赠品功能在弹窗中正常工作
- [ ] 测试添加到购物车

**测试5.3：变体选择模式**
- [ ] 测试下拉菜单（dropdown）模式
- [ ] 测试按钮（buttons）模式
- [ ] 测试启用多选项（enable_options）模式
- [ ] 确认所有模式下赠品功能正常

---

## 性能测试

**测试6.1：页面加载**
- [ ] 使用浏览器开发者工具测量页面加载时间
- [ ] 确认增加的加载时间 < 100ms
- [ ] 检查网络请求（不应有额外的赠品图片请求）

**测试6.2：交互响应**
- [ ] 点击赠品复选框的响应时间 < 50ms
- [ ] 选项切换的响应时间 < 100ms
- [ ] 购物车添加的响应时间 < 500ms

---

## 回归测试

**测试7.1：现有功能不受影响**
- [ ] 普通产品（无赠品配置）的变体选择正常工作
- [ ] 购物车添加（无赠品）正常工作
- [ ] 产品页面的其他功能（评论、推荐等）正常
- [ ] 移动端导航和布局正常

---

## 测试结果记录

| 测试项 | 状态 | 问题描述 | 优先级 |
|--------|------|----------|--------|
| 示例：赠品行显示 | ✅ 通过 | - | - |
| 示例：购物车添加 | ❌ 失败 | 数量显示错误 | 高 |

**测试完成日期:** ___________  
**测试人员:** ___________  
**测试环境:** ___________

---

## 常见问题排查

### 问题1：赠品行不显示
- 检查metafield是否正确配置
- 确认赠品产品存在且已发布
- 查看浏览器控制台是否有JavaScript错误
- 确认CSS文件已加载

### 问题2：选项值仍然显示
- 确认metafield中的option_name和option_value完全匹配（区分大小写）
- 清除浏览器缓存
- 检查Liquid代码中的过滤逻辑

### 问题3：添加购物车失败
- 打开浏览器控制台查看网络请求
- 确认赠品变体ID有效
- 检查Shopify API响应
- 确认赠品有库存或允许超卖

### 问题4：AJAX更新后赠品状态丢失
- 确认JavaScript代码中的状态保存逻辑
- 检查fetch拦截器是否正常工作
- 验证restoreGiftStateAfterAjax函数是否被调用

---

## 生产环境发布前清单

- [ ] 所有测试项通过
- [ ] 高优先级问题已修复
- [ ] 在staging环境测试至少3天
- [ ] 获得产品经理/利益相关者批准
- [ ] 创建回滚计划
- [ ] 准备用户文档
- [ ] 通知客服团队新功能
- [ ] 设置监控和分析跟踪
